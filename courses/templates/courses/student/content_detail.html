{% extends "base.html" %}
{% load course %}
{% load embed_video_tags %}

{% block title %}{{ content.item.title }} - {{ module.title }} - Ta3lem{% endblock %}

{% block extra_css %}
<style>
    /* Sidebar Styles */
    .module-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .module-content.expanded {
        max-height: 2000px;
    }

    .chevron-icon {
        transition: transform 0.3s ease;
    }

    .chevron-icon.rotated {
        transform: rotate(180deg);
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Breadcrumb -->
        <div class="mb-6">
            <nav class="flex flex-wrap items-center gap-2 text-sm">
                <a href="{% url 'student_course_list' %}" class="text-blue-600 hover:text-blue-700 font-semibold">Kursus Saya</a>
                <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                <a href="{% url 'student_course_detail' course.pk %}" class="text-blue-600 hover:text-blue-700 font-semibold truncate max-w-[150px] sm:max-w-none">{{ course.title }}</a>
                <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                <span class="text-gray-600 truncate max-w-[150px] sm:max-w-none">{{ content.item.title }}</span>
            </nav>
        </div>

        <div class="flex gap-6 relative">
            <!-- Collapsible Sidebar -->
            <div id="courseSidebar" class="w-80 flex-shrink-0 transition-all duration-300">
                <div class="sticky top-20">
                    <!-- Sidebar Header -->
                    <div class="bg-white rounded-t-2xl shadow-lg border-b border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-bold text-gray-900 flex items-center">
                                <i class="fas fa-list-ul text-blue-600 mr-2"></i>
                                Kurikulum
                            </h2>
                            <button onclick="toggleFullSidebar()"
                                    id="sidebarToggleBtn"
                                    class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                                    title="Collapse sidebar">
                                <i class="fas fa-chevron-left text-gray-600"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">{{ modules_data|length }} Modul</span>
                            <span class="text-blue-600 font-semibold">{{ enrollment.progress_percentage|floatformat:0 }}% Selesai</span>
                        </div>
                    </div>

                    <!-- Modules List -->
                    <div class="bg-white rounded-b-2xl shadow-lg max-h-[calc(100vh-12rem)] overflow-y-auto custom-scrollbar">
                        {% for module_data in modules_data %}
                            <div class="module-item border-b border-gray-100 last:border-b-0">
                                <!-- Module Header -->
                                <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-blue-50 transition-colors"
                                     onclick="toggleModule('module{{ forloop.counter }}')">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 {% if module_data.progress.is_completed %}bg-green-500{% else %}bg-blue-500{% endif %}">
                                            {% if module_data.progress.is_completed %}
                                                <i class="fas fa-check text-white"></i>
                                            {% else %}
                                                <span class="text-white font-bold text-sm">{{ forloop.counter }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-semibold text-gray-900 text-sm line-clamp-2">{{ module_data.module.title }}</h3>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="text-xs text-gray-500">{{ module_data.completed_contents }}/{{ module_data.total_contents }}</span>
                                                <div class="flex-1 bg-gray-200 rounded-full h-1.5">
                                                    <div class="{% if module_data.progress.is_completed %}bg-green-500{% else %}bg-blue-500{% endif %} h-1.5 rounded-full transition-all duration-300"
                                                         style="width: {{ module_data.completion_percentage }}%"></div>
                                                </div>
                                                <span class="text-xs font-semibold text-gray-600">{{ module_data.completion_percentage|floatformat:0 }}%</span>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-down text-gray-400 chevron-icon" id="chevron{{ forloop.counter }}"></i>
                                    </div>
                                </div>

                                <!-- Module Contents (Collapsible) -->
                                <div class="module-content {% if module_data.module.pk == module.pk %}expanded{% endif %}" id="module{{ forloop.counter }}">
                                    <div class="bg-gray-50 px-4 py-2">
                                        {% if module_data.contents_with_progress %}
                                            {% for item in module_data.contents_with_progress %}
                                                <a href="{% url 'student_content_view' course.pk module_data.module.pk item.content.pk %}"
                                                   class="content-item flex items-center gap-3 p-3 rounded-lg transition-all duration-200 group mb-1 {% if item.content.pk == content.pk %}bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg{% else %}hover:bg-white{% endif %}">
                                                    <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 {% if item.is_completed %}bg-green-500{% elif item.content.pk == content.pk %}bg-white/20{% else %}border-2 border-gray-300{% endif %}">
                                                        {% if item.is_completed %}
                                                            <i class="fas fa-check text-white text-xs"></i>
                                                        {% elif item.content.pk == content.pk %}
                                                            <i class="fas fa-play text-white text-xs"></i>
                                                        {% else %}
                                                            <i class="fas fa-circle text-gray-300 text-xs"></i>
                                                        {% endif %}
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-sm font-medium truncate {% if item.content.pk == content.pk %}text-white{% else %}text-gray-700 group-hover:text-blue-600{% endif %}">{{ item.content.item.title }}</p>
                                                    </div>
                                                    <i class="fas fa-{% if item.content.item.content_type == 'video' %}video{% elif item.content.item.content_type == 'file' %}file-pdf{% else %}file-text{% endif %} {% if item.content.pk == content.pk %}text-white{% else %}text-gray-400{% endif %} text-xs"></i>
                                                </a>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-xs text-gray-500 text-center py-2">Belum ada konten</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Collapsed Sidebar State -->
            <div id="collapsedSidebar" class="hidden w-16 flex-shrink-0">
                <div class="sticky top-20">
                    <div class="bg-white rounded-2xl shadow-lg p-3 flex flex-col items-center gap-3">
                        <button onclick="toggleFullSidebar()"
                                class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                                title="Expand sidebar">
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        </button>
                        <div class="h-px bg-gray-200 w-full"></div>
                        {% for module_data in modules_data %}
                            <div class="relative group">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center {% if module_data.progress.is_completed %}bg-green-500{% else %}bg-blue-500{% endif %} cursor-pointer"
                                     title="{{ module_data.module.title }}">
                                    {% if module_data.progress.is_completed %}
                                        <i class="fas fa-check text-white text-sm"></i>
                                    {% else %}
                                        <span class="text-white font-bold text-xs">{{ forloop.counter }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 min-w-0">
                <!-- Content Header -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl shadow-xl p-6 mb-6 text-white">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <p class="text-sm text-blue-100 mb-2 flex items-center">
                                <i class="fas fa-layer-group mr-2"></i>{{ module.title }}
                            </p>
                            <h1 class="text-2xl sm:text-3xl font-extrabold mb-2">{{ content.item.title }}</h1>
                        </div>
                        {% if content_progress.is_completed %}
                            <div class="flex-shrink-0 ml-4">
                                <div class="w-12 h-12 sm:w-14 sm:h-14 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                                    <i class="fas fa-check text-xl sm:text-2xl text-white"></i>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Content Display -->
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 mb-6 border border-gray-100">
                    {% if content.item.content_type == 'video' %}
                        <!-- Video Content -->
                        <div class="aspect-video bg-gray-900 rounded-xl overflow-hidden mb-6">
                            {% if content.item.url %}
                                {% video content.item.url "small" %}
                            {% elif content.item.file %}
                                <video controls class="w-full h-full">
                                    <source src="{{ content.item.file.url }}" type="video/mp4">
                                    Browser Anda tidak support video tag.
                                </video>
                            {% endif %}
                        </div>
                    {% elif content.item.content_type == 'image' %}
                        <!-- Image Content -->
                        <div class="mb-6">
                            {% if content.item.file %}
                                <img src="{{ content.item.file.url }}"
                                     alt="{{ content.item.title }}"
                                     class="w-full rounded-xl shadow-lg">
                            {% endif %}
                        </div>
                    {% elif content.item.content_type == 'file' %}
                        <!-- File Content -->
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-6 text-center">
                            <i class="fas fa-file-pdf text-6xl text-blue-500 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">{{ content.item.title }}</h3>
                            {% if content.item.file %}
                                <a href="{{ content.item.file.url }}"
                                   target="_blank"
                                   download
                                   class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200">
                                    <i class="fas fa-download mr-2"></i>Download File
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Text Content -->
                    {% if content.item.content %}
                        <div class="prose prose-lg max-w-none">
                            <div class="text-gray-800 leading-relaxed">
                                {{ content.item.content|safe }}
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Mark as Complete Button -->
                {% if not content_progress.is_completed %}
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6 border border-gray-100">
                        <form method="post"
                              action="{% url 'mark_content_complete' course.pk module.pk content.pk %}"
                              id="complete-form">
                            {% csrf_token %}
                            <div class="flex flex-col sm:flex-row items-center gap-4">
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-900 mb-1">Selesai Mempelajari?</h3>
                                    <p class="text-sm text-gray-600">Tandai konten ini sebagai selesai untuk melanjutkan.</p>
                                </div>
                                <button type="submit"
                                        class="w-full sm:w-auto bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center">
                                    <i class="fas fa-check-circle mr-2"></i>Tandai Selesai
                                </button>
                            </div>
                        </form>
                    </div>
                {% else %}
                    <div class="bg-green-50 border-2 border-green-300 rounded-2xl p-6 mb-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-check text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-green-700">Konten Selesai!</h3>
                                <p class="text-sm text-green-600">Diselesaikan pada {{ content_progress.completed_at|date:"d M Y, H:i" }}</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Navigation -->
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                    {% if previous_content %}
                        <a href="{% url 'student_content_view' course.pk module.pk previous_content.pk %}"
                           class="flex-1 bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 px-6 rounded-xl border-2 border-gray-300 transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-arrow-left mr-2"></i>Sebelumnya
                        </a>
                    {% else %}
                        <a href="{% url 'student_course_detail' course.pk %}"
                           class="flex-1 bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 px-6 rounded-xl border-2 border-gray-300 transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-home mr-2"></i>Kembali ke Kursus
                        </a>
                    {% endif %}

                    {% if next_content %}
                        {% if next_module %}
                            <a href="{% url 'student_content_view' course.pk next_module.pk next_content.pk %}"
                               class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center">
                                Selanjutnya<i class="fas fa-arrow-right ml-2"></i>
                            </a>
                        {% else %}
                            <a href="{% url 'student_content_view' course.pk module.pk next_content.pk %}"
                               class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center">
                                Selanjutnya<i class="fas fa-arrow-right ml-2"></i>
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'student_course_detail' course.pk %}"
                           class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center">
                            Selesai!<i class="fas fa-trophy ml-2"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>



    <script>
        // Toggle individual module content
        function toggleModule(moduleId) {
            const moduleContent = document.getElementById(moduleId);
            const chevronId = 'chevron' + moduleId.replace('module', '');
            const chevron = document.getElementById(chevronId);

            if (moduleContent && chevron) {
                moduleContent.classList.toggle('expanded');
                chevron.classList.toggle('rotated');
            }
        }

        // Toggle between full and collapsed sidebar
        function toggleFullSidebar() {
            const fullSidebar = document.getElementById('courseSidebar');
            const collapsedSidebar = document.getElementById('collapsedSidebar');

            if (fullSidebar && collapsedSidebar) {
                fullSidebar.classList.toggle('hidden');
                collapsedSidebar.classList.toggle('hidden');
            }
        }

        // Auto-expand current module on load
        document.addEventListener('DOMContentLoaded', function() {
            const currentModuleContent = document.querySelector('.module-content.expanded');
            if (currentModuleContent) {
                const moduleId = currentModuleContent.id;
                const chevronId = 'chevron' + moduleId.replace('module', '');
                const chevron = document.getElementById(chevronId);
                if (chevron) {
                    chevron.classList.add('rotated');
                }
            }
        });

        // Auto-submit complete form with AJAX
        const completeForm = document.getElementById('complete-form');
        if (completeForm) {
            completeForm.addEventListener('submit', function(e) {
                e.preventDefault();

                fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload page to show updated state
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Fallback: submit form normally
                    this.submit();
                });
            });
        }
    </script>
{% endblock %}

