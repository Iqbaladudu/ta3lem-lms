{% extends "base.html" %}
{% load course %}
{% load embed_video_tags %}
{% load static %}

{% block title %}{{ content.title }} - {{ module.title }} - Ta3lem{% endblock %}

{% block extra_css %}
<style>
    /* Custom Scrollbar for Sidebar */
    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Focus indicators for accessibility */
    .focus-ring:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
    }
    
    .focus-ring:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
    }

    /* Skip link for accessibility */
    .skip-link {
        position: absolute;
        top: -100%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        transition: top 0.2s ease;
    }
    
    .skip-link:focus {
        top: 1rem;
    }

    /* Smooth transitions */
    .transition-smooth {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Success animation for mark complete */
    @keyframes successPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .success-pulse {
        animation: successPulse 0.4s ease-in-out;
    }

    /* Reading progress bar */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, #4f46e5, #6366f1);
        z-index: 100;
        transition: width 0.1s ease-out;
    }

    /* Content icons styling */
    .content-icon {
        width: 1.25rem;
        height: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.25rem;
        flex-shrink: 0;
    }

    /* Safe area for mobile bottom navigation */
    .safe-area-bottom {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
    }
</style>
{% endblock %}

{% block content %}
<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-link bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium shadow-lg focus-ring">
    Skip to main content
</a>

<!-- Reading Progress Bar -->
<div class="reading-progress lg:block hidden" 
     x-data="{ 
         progress: 0,
         updateProgress() {
             const main = document.getElementById('main-content');
             if (!main) return;
             const scrollTop = window.scrollY;
             const docHeight = main.scrollHeight - window.innerHeight;
             this.progress = docHeight > 0 ? Math.min((scrollTop / docHeight) * 100, 100) : 0;
         }
     }"
     x-init="updateProgress()"
     @scroll.window="updateProgress()"
     :style="{ width: progress + '%' }">
</div>

<div class="bg-slate-50 min-h-screen flex flex-col lg:flex-row h-screen overflow-hidden" 
     x-data="{ 
         sidebarOpen: false, 
         desktopSidebarOpen: true,
         markingComplete: false,
         showSuccess: false,
         navigate(selector) {
             if (document.activeElement?.matches('input, textarea')) return;
             document.querySelector(selector)?.click();
         }
     }"
     @keydown.left.window="navigate('.nav-prev')"
     @keydown.right.window="navigate('.nav-next')">
    
    <!-- Mobile Header -->
    <header class="lg:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between shrink-0 z-20" role="banner">
        <div class="flex items-center gap-3 overflow-hidden">
            <a href="{% url 'student_course_detail' course.pk %}" 
               class="text-slate-400 hover:text-slate-600 p-1 rounded-md focus-ring transition-colors"
               aria-label="Back to course overview">
                <i class="fas fa-chevron-left" aria-hidden="true"></i>
                <span class="sr-only">Back to course</span>
            </a>
            <h1 class="font-semibold text-slate-900 truncate">{{ content.title }}</h1>
        </div>
        <button @click="sidebarOpen = !sidebarOpen" 
                class="text-slate-500 p-2 hover:bg-slate-100 rounded-lg focus-ring transition-colors"
                :aria-expanded="sidebarOpen.toString()"
                aria-controls="course-sidebar"
                aria-label="Toggle course navigation">
            <i class="fas" :class="sidebarOpen ? 'fa-times' : 'fa-bars'" aria-hidden="true"></i>
        </button>
    </header>

    <!-- Sidebar (Course Navigation) -->
    <aside id="course-sidebar"
           class="fixed inset-0 z-50 lg:z-auto lg:static lg:shrink-0 bg-white border-r border-slate-200 flex flex-col transition-smooth"
           :class="{
              'translate-x-0': sidebarOpen, 
              '-translate-x-full lg:translate-x-0': !sidebarOpen,
              'lg:w-80': desktopSidebarOpen,
              'lg:w-0 lg:border-r-0 lg:overflow-hidden': !desktopSidebarOpen
           }"
           role="navigation"
           aria-label="Course content navigation">
        
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50/50" 
             :class="{'lg:hidden': !desktopSidebarOpen}">
            <div class="min-w-0">
                <h2 class="font-bold text-slate-900 text-sm mb-1 line-clamp-1">{{ course.title }}</h2>
                <div class="flex items-center gap-2">
                    <div class="flex-1 w-24 bg-slate-200 rounded-full h-1.5"
                         role="progressbar"
                         aria-valuenow="{{ enrollment.progress_percentage|floatformat:0 }}"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-label="Course progress: {{ enrollment.progress_percentage|floatformat:0 }}%">
                        <div class="bg-indigo-600 h-1.5 rounded-full transition-all duration-500" 
                             style="width: {{ enrollment.progress_percentage }}%"></div>
                    </div>
                    <span class="text-xs text-slate-500 font-medium">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                </div>
            </div>
            <button @click="sidebarOpen = false" 
                    class="lg:hidden p-2 text-slate-500 hover:text-slate-700 bg-white rounded-md shadow-sm border border-slate-200 focus-ring transition-colors"
                    aria-label="Close navigation">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>

        <!-- Sidebar List -->
        <div class="flex-1 overflow-y-auto sidebar-scroll" :class="{'lg:hidden': !desktopSidebarOpen}">
            <nav class="divide-y divide-slate-100" aria-label="Course modules">
                {% for module_data in modules_data %}
                <div x-data="{ expanded: {% if module_data.module.pk == module.pk %}true{% else %}false{% endif %} }">
                    <button @click="expanded = !expanded" 
                            class="w-full text-left p-4 hover:bg-slate-50 transition-colors flex items-start justify-between gap-3 focus-ring"
                            :aria-expanded="expanded.toString()"
                            aria-controls="module-{{ module_data.module.pk }}">
                        <div class="min-w-0">
                            <p class="text-sm font-semibold text-slate-900 line-clamp-1">{{ module_data.module.title }}</p>
                            <p class="text-xs text-slate-500 mt-0.5">
                                <span class="sr-only">Completed </span>{{ module_data.completed_contents }}<span class="sr-only"> of </span><span aria-hidden="true">/</span>{{ module_data.total_contents }}<span class="sr-only"> lessons</span>
                            </p>
                        </div>
                        <i class="fas fa-chevron-down text-xs text-slate-400 transition-transform mt-1" 
                           :class="expanded ? 'rotate-180' : ''"
                           aria-hidden="true"></i>
                    </button>
                    
                    <div x-show="expanded" x-collapse id="module-{{ module_data.module.pk }}">
                        <ul class="bg-slate-50/50 pb-2" role="list">
                            {% if module_data.contents_with_progress %}
                                {% for item in module_data.contents_with_progress %}
                                <li>
                                    <a href="{% url 'student_content_view' course.pk module_data.module.pk item.content.pk %}"
                                       class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors border-l-2 focus-ring
                                              {% if item.content.pk == content.pk %}
                                                bg-indigo-50 border-indigo-600 text-indigo-700 font-medium
                                              {% else %}
                                                border-transparent text-slate-600 hover:bg-slate-100 hover:text-slate-900
                                              {% endif %}"
                                       {% if item.content.pk == content.pk %}aria-current="page"{% endif %}>
                                        
                                        <!-- Content Type Icon with Status -->
                                        <div class="content-icon {% if item.is_completed %}bg-emerald-100{% elif item.content.pk == content.pk %}bg-indigo-100{% else %}bg-slate-100{% endif %}">
                                            {% if item.is_completed %}
                                                <i class="fas fa-check text-emerald-600 text-[10px]" aria-hidden="true"></i>
                                                <span class="sr-only">Completed: </span>
                                            {% elif item.content.item.content_type == 'video' %}
                                                <i class="fas fa-play text-{% if item.content.pk == content.pk %}indigo{% else %}slate{% endif %}-500 text-[10px]" aria-hidden="true"></i>
                                                <span class="sr-only">Video: </span>
                                            {% elif item.content.item.content_type == 'file' %}
                                                <i class="fas fa-file-alt text-{% if item.content.pk == content.pk %}indigo{% else %}slate{% endif %}-500 text-[10px]" aria-hidden="true"></i>
                                                <span class="sr-only">File: </span>
                                            {% elif item.content.item.content_type == 'image' %}
                                                <i class="fas fa-image text-{% if item.content.pk == content.pk %}indigo{% else %}slate{% endif %}-500 text-[10px]" aria-hidden="true"></i>
                                                <span class="sr-only">Image: </span>
                                            {% else %}
                                                <i class="fas fa-file-alt text-{% if item.content.pk == content.pk %}indigo{% else %}slate{% endif %}-500 text-[10px]" aria-hidden="true"></i>
                                                <span class="sr-only">Content: </span>
                                            {% endif %}
                                        </div>
                                        
                                        <span class="truncate">{{ item.content.title }}</span>
                                    </a>
                                </li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </nav>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 flex flex-col h-full min-w-0 overflow-y-auto bg-white lg:bg-slate-50/50" role="main">
        
        <!-- Desktop content header (hidden on mobile) -->
        <header class="hidden lg:flex items-center justify-between px-8 py-6 bg-white border-b border-slate-200 sticky top-0 z-10">
             <div class="flex items-center gap-4 min-w-0">
                 <button @click="desktopSidebarOpen = !desktopSidebarOpen" 
                         class="text-slate-400 hover:text-slate-600 transition-colors p-2 rounded-lg hover:bg-slate-100 focus-ring"
                         :aria-expanded="desktopSidebarOpen.toString()"
                         aria-controls="course-sidebar"
                         :aria-label="desktopSidebarOpen ? 'Collapse sidebar' : 'Expand sidebar'">
                     <i class="fas" :class="desktopSidebarOpen ? 'fa-angle-double-left' : 'fa-angle-double-right'" aria-hidden="true"></i>
                 </button>
                 <div class="min-w-0">
                     <nav class="flex items-center text-xs text-slate-500 mb-1" aria-label="Breadcrumb">
                         <ol class="flex items-center">
                             <li>
                                 <a href="{% url 'student_course_detail' course.pk %}" class="hover:text-indigo-600 transition-colors focus-ring rounded">Course</a>
                             </li>
                             <li class="flex items-center">
                                 <i class="fas fa-chevron-right text-[10px] mx-2" aria-hidden="true"></i>
                                 <span class="truncate max-w-[200px]">{{ module.title }}</span>
                             </li>
                         </ol>
                     </nav>
                     <h1 class="text-xl font-bold text-slate-900 truncate">{{ content.title }}</h1>
                 </div>
             </div>
             
             <!-- Navigation Controls -->
             <div class="flex items-center gap-2" role="navigation" aria-label="Lesson navigation">
                 <span class="text-xs text-slate-400 mr-2 hidden xl:inline">
                     <kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-[10px] font-mono">←</kbd>
                     <kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-[10px] font-mono ml-1">→</kbd>
                     to navigate
                 </span>
                 
                 {% if previous_content %}
                 <a href="{% url 'student_content_view' course.pk module.pk previous_content.pk %}" 
                    class="h-9 w-9 rounded-lg border border-slate-200 flex items-center justify-center text-slate-500 hover:border-indigo-300 hover:text-indigo-600 transition-colors focus-ring nav-prev"
                    title="Previous Lesson (← key)"
                    aria-label="Go to previous lesson: {{ previous_content.title }}">
                     <i class="fas fa-chevron-left" aria-hidden="true"></i>
                 </a>
                 {% else %}
                 <span class="h-9 w-9 rounded-lg border border-slate-100 flex items-center justify-center text-slate-300 cursor-not-allowed" aria-disabled="true" title="No previous lesson">
                     <i class="fas fa-chevron-left" aria-hidden="true"></i>
                 </span>
                 {% endif %}
                 
                 {% if next_content %}
                     {% if next_module %}
                     <a href="{% url 'student_content_view' course.pk next_module.pk next_content.pk %}" 
                        class="h-9 w-9 rounded-lg border border-slate-200 flex items-center justify-center text-slate-500 hover:border-indigo-300 hover:text-indigo-600 transition-colors focus-ring nav-next"
                        title="Next: {{ next_module.title }} (→ key)"
                        aria-label="Go to next lesson: {{ next_content.title }} in {{ next_module.title }}">
                         <i class="fas fa-chevron-right" aria-hidden="true"></i>
                     </a>
                     {% else %}
                     <a href="{% url 'student_content_view' course.pk module.pk next_content.pk %}" 
                        class="h-9 w-9 rounded-lg border border-slate-200 flex items-center justify-center text-slate-500 hover:border-indigo-300 hover:text-indigo-600 transition-colors focus-ring nav-next"
                        title="Next Lesson (→ key)"
                        aria-label="Go to next lesson: {{ next_content.title }}">
                         <i class="fas fa-chevron-right" aria-hidden="true"></i>
                     </a>
                     {% endif %}
                 {% else %}
                 <span class="h-9 w-9 rounded-lg border border-slate-100 flex items-center justify-center text-slate-300 cursor-not-allowed" aria-disabled="true" title="No more lessons">
                     <i class="fas fa-chevron-right" aria-hidden="true"></i>
                 </span>
                 {% endif %}
             </div>
        </header>

        <!-- Content Viewer -->
        <article class="flex-1 p-4 sm:p-6 lg:p-10 max-w-5xl mx-auto w-full pb-32 lg:pb-10">
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                <!-- Content Render Block -->
                <div class="prose prose-slate max-w-none p-6 sm:p-8 [&_iframe]:!w-full [&_iframe]:!aspect-video [&_iframe]:!rounded-xl [&_iframe]:shadow-lg [&_iframe]:bg-slate-100 [&_img]:!rounded-xl [&_img]:shadow-sm">
                    {% for content_item in content.items.all %}
                        {{ content_item.item.render|safe }}
                    {% empty %}
                        <!-- Enhanced Empty State -->
                        <div class="text-center py-16" role="status">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-inbox text-2xl text-slate-400" aria-hidden="true"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-slate-700 mb-2">No content available</h3>
                            <p class="text-slate-500 text-sm max-w-xs mx-auto">
                                This lesson is currently being prepared. Please check back later or contact your instructor.
                            </p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Complete Action -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-6 bg-indigo-50 rounded-xl p-6 border border-indigo-100"
                 :class="{ 'success-pulse': showSuccess }">
                <div>
                     <h3 class="font-bold text-indigo-900 text-lg">Finished with this lesson?</h3>
                     <p class="text-indigo-700/80 text-sm">Mark this lesson as complete to track your progress.</p>
                </div>

                {% if not content_progress.is_completed %}
                    <form method="post" 
                          action="{% url 'mark_content_complete' course.pk module.pk content.pk %}"
                          @submit="markingComplete = true; setTimeout(() => showSuccess = true, 500)">
                        {% csrf_token %}
                        <button type="submit" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-sm transition-all flex items-center gap-2 focus-ring disabled:opacity-70 disabled:cursor-not-allowed"
                                :disabled="markingComplete"
                                aria-label="Mark this lesson as complete">
                            <template x-if="!markingComplete">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-check" aria-hidden="true"></i> 
                                    <span>Mark as Complete</span>
                                </span>
                            </template>
                            <template x-if="markingComplete">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
                                    <span>Saving...</span>
                                </span>
                            </template>
                        </button>
                    </form>
                {% else %}
                    <div class="flex items-center gap-2 text-emerald-600 font-bold bg-white px-4 py-2.5 rounded-lg border border-emerald-200 shadow-sm" role="status">
                         <i class="fas fa-check-circle" aria-hidden="true"></i>
                         <span>Completed</span>
                         <span class="sr-only">This lesson has been marked as complete</span>
                    </div>
                {% endif %}
            </div>

        </article>
    </main>
    
    <!-- Backdrop for mobile sidebar -->
    <div x-show="sidebarOpen" 
         @click="sidebarOpen = false"
         class="fixed inset-0 bg-slate-900/50 z-40 lg:hidden transition-opacity"
         x-transition.opacity
         aria-hidden="true">
    </div>

</div>

<!-- Sticky Bottom Navigation (Mobile) -->
<nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 safe-area-bottom z-30" 
     role="navigation" 
     aria-label="Lesson navigation">
    <div class="flex items-center justify-between gap-3 max-w-lg mx-auto">
        {% if previous_content %}
            <a href="{% url 'student_content_view' course.pk module.pk previous_content.pk %}" 
               class="flex-1 py-3 px-4 rounded-lg border border-slate-200 text-center font-medium text-slate-700 hover:bg-slate-50 focus-ring transition-colors nav-prev"
               aria-label="Go to previous lesson">
                <i class="fas fa-chevron-left mr-2 text-sm" aria-hidden="true"></i>
                <span>Previous</span>
            </a>
        {% else %}
            <div class="flex-1 py-3 px-4 rounded-lg border border-slate-100 text-center font-medium text-slate-300 cursor-not-allowed" aria-disabled="true">
                <i class="fas fa-chevron-left mr-2 text-sm" aria-hidden="true"></i>
                <span>Previous</span>
            </div>
        {% endif %}

        {% if next_content %}
            {% if next_module %}
             <a href="{% url 'student_content_view' course.pk next_module.pk next_content.pk %}" 
               class="flex-1 py-3 px-4 rounded-lg bg-indigo-600 text-center font-medium text-white hover:bg-indigo-700 shadow-sm focus-ring transition-colors nav-next"
               aria-label="Go to next lesson">
                <span>Next</span>
                <i class="fas fa-chevron-right ml-2 text-sm" aria-hidden="true"></i>
            </a>
            {% else %}
             <a href="{% url 'student_content_view' course.pk module.pk next_content.pk %}" 
               class="flex-1 py-3 px-4 rounded-lg bg-indigo-600 text-center font-medium text-white hover:bg-indigo-700 shadow-sm focus-ring transition-colors nav-next"
               aria-label="Go to next lesson">
                <span>Next</span>
                <i class="fas fa-chevron-right ml-2 text-sm" aria-hidden="true"></i>
            </a>
            {% endif %}
        {% else %}
            <div class="flex-1 py-3 px-4 rounded-lg bg-slate-100 text-center font-medium text-slate-400 cursor-not-allowed" aria-disabled="true">
                <span>Next</span>
                <i class="fas fa-chevron-right ml-2 text-sm" aria-hidden="true"></i>
            </div>
        {% endif %}
    </div>
</nav>
{% endblock %}
