{% extends "base.html" %}
{% load course %}
{% load embed_video_tags %}
{% load static %}

{% block title %}{{ content.title }} - {{ module.title }} - Ta3lem{% endblock %}

{% block extra_css %}
<style>
    /* Custom Scrollbar for Sidebar */
    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen flex flex-col lg:flex-row h-screen overflow-hidden" x-data="{ sidebarOpen: false }">
    
    <!-- Mobile Header -->
    <div class="lg:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between shrink-0 z-20">
        <div class="flex items-center gap-3 overflow-hidden">
            <a href="{% url 'student_course_detail' course.pk %}" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="font-semibold text-slate-900 truncate">{{ content.title }}</h1>
        </div>
        <button @click="sidebarOpen = !sidebarOpen" class="text-slate-500 p-2 hover:bg-slate-100 rounded-lg">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Sidebar (Course Navigation) -->
    <div class="fixed inset-0 z-30 lg:z-auto lg:static lg:w-80 lg:shrink-0 bg-white border-r border-slate-200 flex flex-col transform transition-transform duration-300"
         :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'">
        
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50/50">
            <div>
                <h2 class="font-bold text-slate-900 text-sm mb-1 line-clamp-1">{{ course.title }}</h2>
                <div class="flex items-center gap-2">
                    <div class="flex-1 w-24 bg-slate-200 rounded-full h-1.5">
                        <div class="bg-indigo-600 h-1.5 rounded-full" style="width: {{ enrollment.progress_percentage }}%"></div>
                    </div>
                    <span class="text-xs text-slate-500 font-medium">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                </div>
            </div>
            <button @click="sidebarOpen = false" class="lg:hidden p-2 text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Sidebar List -->
        <div class="flex-1 overflow-y-auto sidebar-scroll">
            <div class="divide-y divide-slate-100">
                {% for module_data in modules_data %}
                <div x-data="{ expanded: {% if module_data.module.pk == module.pk %}true{% else %}false{% endif %} }">
                    <button @click="expanded = !expanded" 
                            class="w-full text-left p-4 hover:bg-slate-50 transition-colors flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <p class="text-sm font-semibold text-slate-900 line-clamp-1">{{ module_data.module.title }}</p>
                            <p class="text-xs text-slate-500 mt-0.5">{{ module_data.completed_contents }}/{{ module_data.total_contents }}</p>
                        </div>
                        <i class="fas fa-chevron-down text-xs text-slate-400 transition-transform mt-1" 
                           :class="expanded ? 'rotate-180' : ''"></i>
                    </button>
                    
                    <div x-show="expanded" x-collapse>
                        <div class="bg-slate-50/50 pb-2">
                            {% if module_data.contents_with_progress %}
                                {% for item in module_data.contents_with_progress %}
                                <a href="{% url 'student_content_view' course.pk module_data.module.pk item.content.pk %}"
                                   class="flex items-center gap-3 px-4 py-2.5 text-sm transition-colors border-l-2
                                          {% if item.content.pk == content.pk %}
                                            bg-indigo-50 border-indigo-600 text-indigo-700 font-medium
                                          {% else %}
                                            border-transparent text-slate-600 hover:bg-slate-100 hover:text-slate-900
                                          {% endif %}">
                                    <div class="flex-shrink-0 w-4">
                                        {% if item.is_completed %}
                                            <i class="fas fa-check-circle text-emerald-500 text-xs"></i>
                                        {% elif item.content.pk == content.pk %}
                                            {% if item.content.item.content_type == 'video' %}<i class="fas fa-play text-indigo-500 text-xs"></i>
                                            {% else %}<i class="fas fa-circle text-indigo-500 text-[8px]"></i>{% endif %}
                                        {% else %}
                                            <i class="far fa-circle text-slate-300 text-[10px]"></i>
                                        {% endif %}
                                    </div>
                                    <span class="truncate">{{ item.content.title }}</span>
                                </a>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col h-full min-w-0 overflow-y-auto bg-white lg:bg-slate-50/50">
        
        <!-- Desktop content header (hidden on mobile) -->
        <div class="hidden lg:flex items-center justify-between px-8 py-6 bg-white border-b border-slate-200 sticky top-0 z-10">
             <div class="min-w-0">
                 <div class="flex items-center text-xs text-slate-500 mb-1">
                     <a href="{% url 'student_course_detail' course.pk %}" class="hover:text-indigo-600 transition-colors">Course</a>
                     <i class="fas fa-chevron-right text-[10px] mx-2"></i>
                     <span class="truncate max-w-[200px]">{{ module.title }}</span>
                 </div>
                 <h1 class="text-xl font-bold text-slate-900 truncate">{{ content.title }}</h1>
             </div>
             
             <div class="flex items-center gap-3">
                 {% if previous_content %}
                 <a href="{% url 'student_content_view' course.pk module.pk previous_content.pk %}" 
                    class="h-9 w-9 rounded-lg border border-slate-200 flex items-center justify-center text-slate-500 hover:border-indigo-300 hover:text-indigo-600 transition-colors nav-prev"
                    title="Previous Lesson">
                     <i class="fas fa-chevron-left"></i>
                 </a>
                 {% endif %}
                 
                 {% if next_content %}
                     {% if next_module %}
                     <a href="{% url 'student_content_view' course.pk next_module.pk next_content.pk %}" 
                        class="h-9 w-9 rounded-lg border border-slate-200 flex items-center justify-center text-slate-500 hover:border-indigo-300 hover:text-indigo-600 transition-colors nav-next"
                        title="Next: {{ next_module.title }}">
                         <i class="fas fa-chevron-right"></i>
                     </a>
                     {% else %}
                     <a href="{% url 'student_content_view' course.pk module.pk next_content.pk %}" 
                        class="h-9 w-9 rounded-lg border border-slate-200 flex items-center justify-center text-slate-500 hover:border-indigo-300 hover:text-indigo-600 transition-colors nav-next"
                        title="Next Lesson">
                         <i class="fas fa-chevron-right"></i>
                     </a>
                     {% endif %}
                 {% endif %}
             </div>
        </div>

        <!-- Content Viewer -->
        <div class="flex-1 p-4 sm:p-6 lg:p-10 max-w-5xl mx-auto w-full">
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                <!-- Content Render Block -->
                <div class="prose prose-slate max-w-none p-6 sm:p-8 [&_iframe]:aspect-video [&_iframe]:w-full [&_iframe]:h-auto [&_iframe]:rounded-lg [&_img]:rounded-lg">
                    {% for content_item in content.items.all %}
                        {{ content_item.item.render|safe }}
                    {% empty %}
                        <p class="text-slate-500 italic">No content available to display.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Complete Action -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-6 bg-indigo-50 rounded-xl p-6 border border-indigo-100">
                <div>
                     <h3 class="font-bold text-indigo-900 text-lg">Finished watching?</h3>
                     <p class="text-indigo-700/80 text-sm">Mark this lesson as complete to track your progress.</p>
                </div>

                {% if not content_progress.is_completed %}
                    <form method="post" action="{% url 'mark_content_complete' course.pk module.pk content.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-sm transition-all flex items-center gap-2">
                             <i class="fas fa-check"></i> Mark as Complete
                        </button>
                    </form>
                {% else %}
                    <div class="flex items-center gap-2 text-emerald-600 font-bold bg-white px-4 py-2 rounded-lg border border-emerald-100">
                         <i class="fas fa-check-circle"></i> Completed
                    </div>
                {% endif %}
            </div>

             <!-- Bottom Navigation (Mobile) -->
             <div class="lg:hidden mt-8 flex items-center justify-between gap-4">
                 {% if previous_content %}
                     <a href="{% url 'student_content_view' course.pk module.pk previous_content.pk %}" 
                        class="flex-1 py-3 px-4 rounded-lg border border-slate-200 text-center font-medium text-slate-700 hover:bg-slate-50">
                         Previous
                     </a>
                 {% else %}
                    <div class="flex-1"></div>
                 {% endif %}

                 {% if next_content %}
                     {% if next_module %}
                      <a href="{% url 'student_content_view' course.pk next_module.pk next_content.pk %}" 
                        class="flex-1 py-3 px-4 rounded-lg bg-indigo-600 text-center font-medium text-white hover:bg-indigo-700 shadow-sm">
                         Next
                     </a>
                     {% else %}
                      <a href="{% url 'student_content_view' course.pk module.pk next_content.pk %}" 
                        class="flex-1 py-3 px-4 rounded-lg bg-indigo-600 text-center font-medium text-white hover:bg-indigo-700 shadow-sm">
                         Next
                     </a>
                     {% endif %}
                 {% endif %}
             </div>

        </div>
    </div>
    
    <!-- Backdrop for mobile sidebar -->
    <div x-show="sidebarOpen" 
         @click="sidebarOpen = false"
         class="fixed inset-0 bg-slate-900/50 z-20 lg:hidden transition-opacity"
         x-transition.opacity>
    </div>

</div>
{% endblock %}
