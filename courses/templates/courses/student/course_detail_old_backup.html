{% extends "base.html" %}
{% load course %}

{% block title %}{{ course.title }} - Ta3lem{% endblock %}

{% block extra_css %}
<style>
    /* Module collapse/expand animation */
    .module-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .module-content.expanded {
        max-height: 2000px;
    }

    .chevron-icon {
        transition: transform 0.3s ease;
    }

    .chevron-icon.rotated {
        transform: rotate(180deg);
    }

    /* Progress animations */
    @keyframes fillProgress {
        from { stroke-dashoffset: 251.2; }
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.5s ease;
        animation: fillProgress 1s ease-out;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Desktop hover effects */
    @media (min-width: 1024px) {
        .module-card {
            transition: all 0.2s ease;
        }

        .module-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .content-item {
            transition: all 0.2s ease;
        }

        .content-item:hover {
            transform: translateX(2px);
        }
            transform: scale(1.1) rotate(5deg);
        }

        .stat-icon {
            transition: transform 0.3s ease;
        }

        /* Module expansion animation enhanced */
        .module-header {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .module-header:hover {
            background-color: rgba(249, 250, 251, 0.8);
        }

        /* Enhanced tooltip */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-size: 13px;
            border-radius: 8px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Enhanced focus states */
        *:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* LMS Breadcrumb */
        .lms-breadcrumb {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Course header card */
        .lms-course-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 2.5rem;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .lms-course-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="rgba(255,255,255,0.05)"/></svg>');
            opacity: 0.3;
        }

        /* Progress tracker */
        .lms-progress-tracker {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Timeline style for modules */
        .lms-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .lms-timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
        }

        .lms-timeline-item {
            position: relative;
            margin-bottom: 1rem;
        }

        .lms-timeline-item::before {
            content: '';
            position: absolute;
            left: -2.5rem;
            top: 1.5rem;
            width: 12px;
            height: 12px;
            background: white;
            border: 3px solid #3b82f6;
            border-radius: 50%;
            z-index: 1;
        }

        .lms-timeline-item.completed::before {
            background: #10b981;
            border-color: #10b981;
        }

        /* Certificate badge */
        .certificate-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* Activity feed */
        .activity-feed-item {
            padding: 1rem;
            border-left: 3px solid #e5e7eb;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .activity-feed-item:hover {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        /* Quick stats grid */
        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* Module collapse animation */
        .module-content {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.3s ease;
        }

        .module-content.expanded {
            opacity: 1;
        }

        .module-content:not(.expanded) {
            opacity: 0;
        }
    }

    /* Tablet optimizations */
    @media (min-width: 768px) and (max-width: 1023px) {
        .tablet-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
    }

    /* Ultra-wide screen optimizations */
    @media (min-width: 1920px) {
        .desktop-grid {
            grid-template-columns: 1fr 420px;
            gap: 3rem;
        }

        .container-ultrawide {
            max-width: 1600px;
            margin: 0 auto;
        }
    }
</style>
{% endblock %}


{% block content %}
    <!-- Desktop LMS: Sidebar Navigation -->
    <div class="hidden lg:block lms-sidebar">
        <div class="p-6">
            <!-- Logo/Brand -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-graduation-cap"></i>
                    Ta3lem
                </h2>
                <p class="text-sm text-gray-400 mt-1">Learning Management System</p>
            </div>

            <!-- Course Navigation -->
            <div class="space-y-1">
                <a href="{% url 'student_course_list' %}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-gray-300 hover:text-white">
                    <i class="fas fa-th-large w-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/10 text-white">
                    <i class="fas fa-book-open w-5"></i>
                    <span class="font-medium">Kursus Ini</span>
                </a>
                <a href="#modules" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-gray-300 hover:text-white">
                    <i class="fas fa-list w-5"></i>
                    <span class="font-medium">Daftar Modul</span>
                </a>
                <a href="#progress" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-gray-300 hover:text-white">
                    <i class="fas fa-chart-line w-5"></i>
                    <span class="font-medium">Progress Saya</span>
                </a>
            </div>

            <div class="border-t border-white/10 my-6"></div>

            <!-- Quick Stats in Sidebar -->
            <div class="space-y-3">
                <div class="bg-white/10 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-400">Progress</span>
                        <span class="text-sm font-bold text-white">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-2">
                        <div class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all" 
                             style="width: {{ enrollment.progress_percentage }}%"></div>
                    </div>
                </div>

                <div class="bg-white/10 rounded-lg p-3 space-y-2 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Total Modul</span>
                        <span class="font-bold text-white">{{ course.modules.count }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Total Konten</span>
                        <span class="font-bold text-white">{{ contents_data|length }}</span>
                    </div>
                </div>
            </div>

            <div class="border-t border-white/10 my-6"></div>

            <!-- Recent Activity -->
            <div>
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Aktivitas Terakhir</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex items-start gap-2 text-gray-300">
                        <i class="fas fa-clock text-xs text-gray-500 mt-1"></i>
                        <div>
                            <p class="text-xs">Bergabung kursus</p>
                            <p class="text-xs text-gray-500">{{ enrollment.enrolled_at|timesince }} lalu</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructor Card at Bottom -->
        <div class="p-6 border-t border-white/10 mt-auto">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white text-lg"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-400">Instruktur</p>
                    <p class="font-semibold text-white">{{ course.owner.username }}</p>
                </div>
            </div>
            <button class="w-full bg-white/10 hover:bg-white/20 text-white rounded-lg py-2 text-sm font-medium transition-colors">
                <i class="fas fa-envelope mr-2"></i>Hubungi
            </button>
        </div>
    </div>

    <!-- Desktop LMS: Main Content Wrapper -->
    <div class="lms-content-wrapper lg:lms-content-wrapper">
        <!-- Mobile Header (unchanged) -->
        <div class="lg:hidden bg-gradient-to-br from-blue-600 via-purple-600 to-pink-500 text-white safe-top">
            <div class="px-4 pt-3 pb-4">
                <div class="flex items-center justify-between mb-3">
                    <a href="{% url 'student_course_list' %}"
                       class="flex items-center justify-center w-9 h-9 bg-white/20 backdrop-blur-sm rounded-full active:bg-white/30 transition-colors">
                        <i class="fas fa-arrow-left text-sm"></i>
                    </a>
                    
                    <div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1.5">
                        <div class="relative w-8 h-8">
                            <svg class="transform -rotate-90 w-8 h-8">
                                <circle cx="16" cy="16" r="14" stroke="rgba(255,255,255,0.3)" stroke-width="3" fill="none" />
                                <circle cx="16" cy="16" r="14" stroke="white" stroke-width="3" fill="none"
                                        stroke-dasharray="87.96"
                                        stroke-dashoffset="{{ 87.96|floatformat:2|add:0|mul:-1|mul:enrollment.progress_percentage|div:100|add:87.96 }}"
                                        class="progress-ring-circle" stroke-linecap="round" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-xs font-bold">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <h1 class="text-xl font-bold mb-1 leading-tight line-clamp-2">{{ course.title }}</h1>
                <p class="text-xs text-blue-100 flex items-center gap-2 flex-wrap">
                    <span class="flex items-center gap-1">
                        <i class="fas fa-user text-xs"></i>
                        {{ course.owner.username }}
                    </span>
                    <span>•</span>
                    <span class="flex items-center gap-1">
                        <i class="fas fa-layer-group text-xs"></i>
                        {{ course.modules.count }} Modul
                    </span>
                </p>
            </div>

            <div class="px-4 pb-4">
                <div class="bg-white/20 backdrop-blur-sm rounded-full h-2 overflow-hidden">
                    <div class="bg-white h-full rounded-full transition-all duration-500" 
                         style="width: {{ enrollment.progress_percentage }}%"></div>
                </div>
            </div>
        </div>

        <!-- Desktop: Breadcrumb & Page Header -->
        <div class="hidden lg:block lms-breadcrumb">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <a href="{% url 'student_course_list' %}" class="hover:text-blue-600 transition-colors">Dashboard</a>
                        <i class="fas fa-chevron-right text-xs"></i>
                        <a href="{% url 'student_course_list' %}" class="hover:text-blue-600 transition-colors">Kursus Saya</a>
                        <i class="fas fa-chevron-right text-xs"></i>
                        <span class="text-gray-900 font-medium truncate max-w-md">{{ course.title }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-tooltip="Bookmark" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="far fa-bookmark text-gray-600"></i>
                        </button>
                        <button data-tooltip="Bagikan" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-share-alt text-gray-600"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="bg-gray-50 min-h-screen pb-20 lg:pb-8 safe-bottom">
            <div class="lms-main-content">
                <!-- Left Column: Course Content -->
                <div class="space-y-4 lg:space-y-6">
                    <!-- Desktop: Course Header Card -->
                    <div class="hidden lg:block lms-course-header animate-fade-in">
                        <div class="relative z-10">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h1 class="text-3xl font-bold mb-2">{{ course.title }}</h1>
                                    <p class="text-blue-100 flex items-center gap-4 flex-wrap text-sm">
                                        <span class="flex items-center gap-2">
                                            <i class="fas fa-user"></i>
                                            <span>{{ course.owner.username }}</span>
                                        </span>
                                        <span>•</span>
                                        <span class="flex items-center gap-2">
                                            <i class="fas fa-calendar"></i>
                                            <span>Bergabung {{ enrollment.enrolled_at|date:"d M Y" }}</span>
                                        </span>
                                        <span>•</span>
                                        <span class="flex items-center gap-2">
                                            <i class="fas fa-layer-group"></i>
                                            <span>{{ course.modules.count }} Modul</span>
                                        </span>
                                    </p>
                                </div>
                                <div class="flex items-center gap-3">
                                    {% if enrollment.progress_percentage == 100 %}
                                    <div class="certificate-badge">
                                        <i class="fas fa-award mr-2"></i>Selesai
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div class="bg-white/20 backdrop-blur-sm rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all shadow-lg" 
                                     style="width: {{ enrollment.progress_percentage }}%">
                                    <div class="h-full w-full bg-white/20 animate-pulse"></div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-2 text-sm">
                                <span class="text-blue-100">Progress Pembelajaran</span>
                                <span class="font-bold">{{ enrollment.progress_percentage|floatformat:0 }}% Selesai</span>
                            </div>
                        </div>
                    </div>

                    <!-- Continue Learning CTA -->
                    {% if current_module and current_module_first_content %}
                    <div class="animate-slide-in">
                        <a href="{% url 'student_content_view' course.pk current_module.pk current_module_first_content.pk %}"
                           class="block bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl lg:rounded-3xl p-4 lg:p-6 shadow-lg hover:shadow-xl active:scale-98 transition-all card-press desktop-hover-lift">
                            <div class="flex items-center gap-3 lg:gap-4">
                                <div class="w-12 h-12 lg:w-16 lg:h-16 bg-white/20 backdrop-blur-sm rounded-xl lg:rounded-2xl flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-play text-white text-xl lg:text-3xl"></i>
                                </div>
                                <div class="flex-1 min-w-0 text-white">
                                    <p class="text-xs lg:text-sm font-semibold text-blue-100 mb-0.5 lg:mb-1">Lanjutkan Belajar</p>
                                    <h3 class="font-bold text-sm lg:text-xl line-clamp-1 lg:line-clamp-2">{{ current_module.title }}</h3>
                                    <p class="text-xs lg:text-sm text-blue-100 mt-1 hidden lg:block">{{ current_module_first_content.title }}</p>
                                </div>
                                <div class="hidden lg:flex items-center gap-2 text-white/80">
                                    <span class="text-sm">Mulai</span>
                                    <i class="fas fa-arrow-right text-xl"></i>
                                </div>
                                <i class="lg:hidden fas fa-chevron-right text-white/70"></i>
                            </div>
                        </a>
                    </div>
                    {% endif %}

                    <!-- Course Overview -->
                    <div class="bg-white rounded-xl lg:rounded-2xl shadow-sm overflow-hidden desktop-hover-lift animate-scale-in">
                        <button onclick="toggleOverview()" 
                                class="w-full px-4 lg:px-6 py-3 lg:py-4 flex items-center justify-between hover:bg-gray-50 active:bg-gray-50 transition-colors module-header">
                            <div class="flex items-center gap-2 lg:gap-3">
                                <div class="w-8 h-8 lg:w-10 lg:h-10 bg-blue-100 rounded-lg lg:rounded-xl flex items-center justify-center stat-icon">
                                    <i class="fas fa-info-circle text-blue-600 lg:text-lg"></i>
                                </div>
                                <span class="font-bold text-gray-900 text-sm lg:text-lg">Tentang Kursus</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 text-sm lg:text-base chevron-icon" id="overviewChevron"></i>
                        </button>
                        <div class="module-content px-4 lg:px-6 pb-4 lg:pb-6" id="overviewContent">
                            <p class="text-sm lg:text-base text-gray-700 leading-relaxed lg:leading-loose">{{ course.overview }}</p>
                        </div>
                    </div>

                    <!-- Modules List with Timeline Style (Desktop) -->
                    <div class="animate-slide-in-left" id="modules">
                        <div class="flex items-center justify-between mb-3 lg:mb-6">
                            <h2 class="font-bold text-gray-900 lg:text-2xl flex items-center gap-2">
                                <i class="fas fa-list-ul text-blue-600 hidden lg:inline"></i>
                                Daftar Modul
                            </h2>
                            {% if modules_data %}
                            <button onclick="toggleAllModules()" id="toggleAllBtn"
                                    class="text-xs lg:text-sm text-blue-600 font-semibold hover:text-blue-700 active:text-blue-700 transition-colors flex items-center gap-2">
                                <i class="fas fa-chevron-down"></i>
                                <span>Buka Semua</span>
                            </button>
                            {% endif %}
                        </div>

                        {% if modules_data %}
                            <div class="space-y-3 lg:space-y-4 lg:lms-timeline">
                                {% for module_data in modules_data %}
                                <div class="bg-white rounded-xl lg:rounded-2xl shadow-sm overflow-hidden card-press transition-all animate-slide-in module-card lms-timeline-item {% if module_data.progress.is_completed %}completed{% endif %}"
                                     style="animation-delay: {{ forloop.counter0|mul:50 }}ms">
                                    <!-- Module Header -->
                                    <div onclick="toggleModule('module{{ forloop.counter }}')"
                                         class="px-4 lg:px-6 py-3 lg:py-5 hover:bg-gray-50 active:bg-gray-50 transition-colors cursor-pointer module-header">
                                        <div class="flex items-center gap-3 lg:gap-4">
                                            <!-- Module Number Badge -->
                                            <div class="w-10 h-10 lg:w-14 lg:h-14 rounded-xl lg:rounded-2xl flex items-center justify-center flex-shrink-0 
                                                        {% if module_data.progress.is_completed %}bg-gradient-to-br from-green-400 to-green-600{% else %}bg-gradient-to-br from-blue-500 to-purple-600{% endif %} 
                                                        shadow-md stat-icon">
                                                {% if module_data.progress.is_completed %}
                                                    <i class="fas fa-check text-white text-sm lg:text-xl"></i>
                                                {% else %}
                                                    <span class="text-white font-bold text-sm lg:text-lg">{{ forloop.counter }}</span>
                                                {% endif %}
                                            </div>

                                            <!-- Module Info -->
                                            <div class="flex-1 min-w-0">
                                                <h3 class="font-bold text-gray-900 text-sm lg:text-lg mb-1 line-clamp-2">{{ module_data.module.title }}</h3>
                                                <div class="flex items-center gap-2 lg:gap-3 text-xs lg:text-sm text-gray-600 flex-wrap">
                                                    <span class="{% if module_data.progress.is_completed %}text-green-600{% else %}text-blue-600{% endif %} font-semibold">
                                                        {{ module_data.completed_contents }}/{{ module_data.total_contents }} Selesai
                                                    </span>
                                                    <span>•</span>
                                                    <span class="font-medium">{{ module_data.completion_percentage|floatformat:0 }}%</span>
                                                    <span class="hidden lg:inline">•</span>
                                                    <span class="hidden lg:inline flex items-center gap-1">
                                                        <i class="fas fa-file-alt text-xs"></i>
                                                        {{ module_data.module.contents.count }} Konten
                                                    </span>
                                                </div>
                                            </div>

                                            <!-- Status Badge (Desktop) -->
                                            <div class="hidden lg:block">
                                                {% if module_data.progress.is_completed %}
                                                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">
                                                    <i class="fas fa-check-circle mr-1"></i>Selesai
                                                </span>
                                                {% elif module_data.completed_contents > 0 %}
                                                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold">
                                                    <i class="fas fa-play-circle mr-1"></i>Berlangsung
                                                </span>
                                                {% else %}
                                                <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold">
                                                    <i class="fas fa-circle mr-1"></i>Belum Dimulai
                                                </span>
                                                {% endif %}
                                            </div>

                                            <!-- Chevron -->
                                            <i class="fas fa-chevron-down text-gray-400 lg:text-lg chevron-icon transition-transform" id="chevron{{ forloop.counter }}"></i>
                                        </div>

                                        <!-- Progress Bar -->
                                        <div class="mt-3 lg:mt-4">
                                            <div class="w-full bg-gray-200 rounded-full h-1.5 lg:h-2 overflow-hidden">
                                                <div class="{% if module_data.progress.is_completed %}bg-gradient-to-r from-green-400 to-green-600{% else %}bg-gradient-to-r from-blue-500 to-purple-600{% endif %} 
                                                            h-1.5 lg:h-2 rounded-full transition-all duration-500 relative"
                                                     style="width: {{ module_data.completion_percentage }}%">
                                                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Module Contents (Collapsible) -->
                                    <div class="module-content" id="module{{ forloop.counter }}">
                                        <div class="px-4 lg:px-6 pb-3 lg:pb-5 bg-gray-50">
                                            {% if module_data.module.contents.all %}
                                                <div class="space-y-2 lg:space-y-2">
                                                    {% for content in module_data.module.contents.all %}
                                                        {% with content_completed=False %}
                                                            {% for cd in contents_data %}
                                                                {% if cd.content.pk == content.pk %}
                                                                    <a href="{% url 'student_content_view' course.pk module_data.module.pk content.pk %}"
                                                                       class="flex items-center gap-3 lg:gap-4 p-3 lg:p-4 rounded-lg lg:rounded-xl hover:bg-white active:bg-white transition-all border border-gray-200 hover:border-blue-300 hover:shadow-sm content-item group">
                                                                        <!-- Status Icon -->
                                                                        <div class="w-7 h-7 lg:w-10 lg:h-10 rounded-lg lg:rounded-xl flex items-center justify-center flex-shrink-0
                                                                                    {% if cd.is_completed %}bg-green-500{% else %}bg-gray-200 group-hover:bg-blue-100{% endif %} transition-all">
                                                                            {% if cd.is_completed %}
                                                                                <i class="fas fa-check text-white text-xs lg:text-sm"></i>
                                                                            {% else %}
                                                                                <i class="fas fa-circle text-gray-400 group-hover:text-blue-500 text-xs transition-colors"></i>
                                                                            {% endif %}
                                                                        </div>
                                                                        
                                                                        <!-- Content Info -->
                                                                        <div class="flex-1 min-w-0">
                                                                            <p class="text-sm lg:text-base font-medium text-gray-900 line-clamp-1 group-hover:text-blue-600 transition-colors">{{ content.title }}</p>
                                                                            <p class="text-xs lg:text-sm text-gray-500 flex items-center gap-2">
                                                                                <i class="fas fa-file-alt text-xs"></i>
                                                                                {{ content.items.count }} item{% if content.items.count > 1 %}s{% endif %}
                                                                            </p>
                                                                        </div>
                                                                        
                                                                        <!-- Desktop: Time estimate (optional) -->
                                                                        <div class="hidden lg:flex items-center gap-2 text-xs text-gray-500">
                                                                            <i class="far fa-clock"></i>
                                                                            <span>~5 menit</span>
                                                                        </div>

                                                                        <i class="fas fa-chevron-right text-gray-400 text-xs lg:text-sm group-hover:text-blue-600 transition-colors"></i>
                                                                    </a>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endwith %}
                                                    {% endfor %}
                                                </div>

                                                <!-- Action Button -->
                                                {% if module_data.first_content %}
                                                <a href="{% url 'student_content_view' course.pk module_data.module.pk module_data.first_content.pk %}"
                                                   class="block w-full mt-4 lg:mt-4 text-center btn-primary
                                                          {% if module_data.progress.is_completed %}
                                                              bg-green-500 hover:bg-green-600
                                                          {% else %}
                                                              bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700
                                                          {% endif %}
                                                          text-white font-semibold py-3 lg:py-3.5 px-4 rounded-lg lg:rounded-xl shadow-sm hover:shadow-lg active:scale-98 transition-all">
                                                    {% if module_data.progress.is_completed %}
                                                        <i class="fas fa-redo mr-2"></i>Tinjau Ulang Modul
                                                    {% elif module_data.completed_contents > 0 %}
                                                        <i class="fas fa-play-circle mr-2"></i>Lanjutkan Belajar
                                                    {% else %}
                                                        <i class="fas fa-rocket mr-2"></i>Mulai Modul Ini
                                                    {% endif %}
                                                </a>
                                                {% endif %}
                                            {% else %}
                                                <p class="text-xs lg:text-sm text-gray-500 text-center py-4 lg:py-6">
                                                    <i class="fas fa-inbox text-2xl text-gray-400 block mb-2"></i>
                                                    Belum ada konten di modul ini
                                                </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="bg-white rounded-xl lg:rounded-2xl shadow-sm p-8 lg:p-12 text-center animate-fade-in">
                                <div class="w-16 h-16 lg:w-24 lg:h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 lg:mb-4">
                                    <i class="fas fa-inbox text-2xl lg:text-4xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900 mb-2">Belum Ada Modul</h3>
                                <p class="text-sm lg:text-base text-gray-600">Instruktur belum menambahkan modul untuk kursus ini</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Right Column: LMS Sidebar (Desktop Only) -->
                <aside class="hidden lg:block space-y-6 desktop-sidebar" id="progress">
                    <!-- Progress Tracker Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 glass-card animate-scale-in border border-gray-100">
                        <div class="flex items-center justify-between mb-5">
                            <h3 class="font-bold text-gray-900 text-lg flex items-center gap-2">
                                <i class="fas fa-chart-pie text-blue-600"></i>
                                Progress Pembelajaran
                            </h3>
                        </div>

                        <!-- Large Progress Circle -->
                        <div class="flex justify-center mb-6">
                            <div class="relative w-32 h-32">
                                <svg class="transform -rotate-90 w-32 h-32">
                                    <circle cx="64" cy="64" r="58" stroke="#e5e7eb" stroke-width="8" fill="none" />
                                    <circle cx="64" cy="64" r="58" stroke="url(#gradient)" stroke-width="8" fill="none"
                                            stroke-dasharray="364"
                                            stroke-dashoffset="{{ 364|floatformat:2|add:0|mul:-1|mul:enrollment.progress_percentage|div:100|add:364 }}"
                                            class="progress-ring-circle" stroke-linecap="round" />
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-3xl font-bold text-gray-900">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                                    <span class="text-xs text-gray-500">Selesai</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="quick-stats-grid gap-3">
                            <div class="stat-card bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center stat-icon">
                                        <i class="fas fa-book text-white"></i>
                                    </div>
                                    <span class="text-2xl font-bold text-blue-900">{{ course.modules.count }}</span>
                                </div>
                                <p class="text-xs text-blue-700 font-medium">Modul</p>
                            </div>

                            <div class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center stat-icon">
                                        <i class="fas fa-file-alt text-white"></i>
                                    </div>
                                    <span class="text-2xl font-bold text-purple-900">{{ contents_data|length }}</span>
                                </div>
                                <p class="text-xs text-purple-700 font-medium">Konten</p>
                            </div>

                            {% with completed_count=0 %}
                                {% for cd in contents_data %}
                                    {% if cd.is_completed %}
                                        {% with completed_count=completed_count|add:1 %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                                <div class="stat-card bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center stat-icon">
                                            <i class="fas fa-check-circle text-white"></i>
                                        </div>
                                        <span class="text-2xl font-bold text-green-900">{{ completed_count }}</span>
                                    </div>
                                    <p class="text-xs text-green-700 font-medium">Selesai</p>
                                </div>
                            {% endwith %}

                            <div class="stat-card bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center stat-icon">
                                        <i class="fas fa-fire text-white"></i>
                                    </div>
                                    <span class="text-2xl font-bold text-orange-900">{{ enrollment.enrolled_at|timesince|slice:":2" }}</span>
                                </div>
                                <p class="text-xs text-orange-700 font-medium">Hari</p>
                            </div>
                        </div>

                        <!-- Milestone -->
                        {% if enrollment.progress_percentage == 100 %}
                        <div class="mt-4 p-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl text-white text-center">
                            <i class="fas fa-trophy text-3xl mb-2"></i>
                            <p class="font-bold">Selamat! Kursus Selesai</p>
                            <p class="text-xs mt-1 text-yellow-100">Anda telah menyelesaikan semua modul</p>
                        </div>
                        {% elif enrollment.progress_percentage >= 75 %}
                        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-xl text-center">
                            <i class="fas fa-medal text-2xl text-blue-600 mb-1"></i>
                            <p class="text-sm font-semibold text-blue-900">Hampir Selesai!</p>
                            <p class="text-xs text-blue-700">Tinggal sedikit lagi</p>
                        </div>
                        {% elif enrollment.progress_percentage >= 50 %}
                        <div class="mt-4 p-3 bg-purple-50 border border-purple-200 rounded-xl text-center">
                            <i class="fas fa-star text-2xl text-purple-600 mb-1"></i>
                            <p class="text-sm font-semibold text-purple-900">Setengah Jalan!</p>
                            <p class="text-xs text-purple-700">Terus belajar!</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 animate-fade-in border border-gray-100">
                        <h3 class="font-bold text-gray-900 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-bolt text-yellow-500"></i>
                            Aksi Cepat
                        </h3>
                        <div class="space-y-2">
                            <button onclick="toggleAllModules()" class="w-full text-left px-4 py-3 rounded-xl bg-gradient-to-r from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100 transition-all flex items-center gap-3 border border-blue-100">
                                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-expand text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-sm text-gray-900">Buka Semua Modul</p>
                                    <p class="text-xs text-gray-600">Lihat semua konten</p>
                                </div>
                            </button>

                            <button class="w-full text-left px-4 py-3 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 transition-all flex items-center gap-3 border border-green-100">
                                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-download text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-sm text-gray-900">Download Materi</p>
                                    <p class="text-xs text-gray-600">Simpan untuk offline</p>
                                </div>
                            </button>

                            {% if enrollment.progress_percentage == 100 %}
                            <button class="w-full text-left px-4 py-3 rounded-xl bg-gradient-to-r from-yellow-50 to-orange-50 hover:from-yellow-100 hover:to-orange-100 transition-all flex items-center gap-3 border border-yellow-200">
                                <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-certificate text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-sm text-gray-900">Dapatkan Sertifikat</p>
                                    <p class="text-xs text-gray-600">Anda telah lulus!</p>
                                </div>
                            </button>
                            {% endif %}

                            <button class="w-full text-left px-4 py-3 rounded-xl bg-gradient-to-r from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 transition-all flex items-center gap-3 border border-purple-100">
                                <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-comments text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-sm text-gray-900">Forum Diskusi</p>
                                    <p class="text-xs text-gray-600">Tanya & jawab</p>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Learning Path -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 animate-slide-in border border-gray-100">
                        <h3 class="font-bold text-gray-900 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-route text-indigo-600"></i>
                            Jalur Pembelajaran
                        </h3>
                        <div class="space-y-3">
                            {% for module_data in modules_data|slice:":5" %}
                            <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer" onclick="toggleModule('module{{ forloop.counter }}'); document.getElementById('module{{ forloop.counter }}').scrollIntoView({behavior: 'smooth', block: 'center'});">
                                <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0
                                            {% if module_data.progress.is_completed %}bg-green-500{% else %}bg-gray-200{% endif %}">
                                    {% if module_data.progress.is_completed %}
                                        <i class="fas fa-check text-white text-xs"></i>
                                    {% else %}
                                        <span class="text-xs font-bold text-gray-600">{{ forloop.counter }}</span>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 line-clamp-1">{{ module_data.module.title }}</p>
                                    <p class="text-xs text-gray-500">{{ module_data.completion_percentage|floatformat:0 }}% selesai</p>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Help & Support -->
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white animate-slide-in">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                                <i class="fas fa-headset text-2xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg">Butuh Bantuan?</h4>
                                <p class="text-xs text-indigo-100">Kami siap membantu</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <button class="w-full bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg py-2.5 text-sm font-medium transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-question-circle"></i>
                                <span>FAQ & Panduan</span>
                            </button>
                            <button class="w-full bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg py-2.5 text-sm font-medium transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-envelope"></i>
                                <span>Hubungi Support</span>
                            </button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Desktop: Floating Action Button -->
    <button onclick="scrollToTop()" class="fab hidden lg:flex" id="scrollTopBtn" style="opacity: 0;">
        <i class="fas fa-arrow-up"></i>
    </button>

<script>
    // Mobile-First JavaScript Functions
    
    // Toggle individual module
    function toggleModule(moduleId) {
        const content = document.getElementById(moduleId);
        const chevronNum = moduleId.replace('module', '');
        const chevron = document.getElementById('chevron' + chevronNum);
        
        content.classList.toggle('expanded');
        chevron.classList.toggle('rotated');
    }

    // Toggle course overview
    function toggleOverview() {
        const content = document.getElementById('overviewContent');
        const chevron = document.getElementById('overviewChevron');
        
        content.classList.toggle('expanded');
        chevron.classList.toggle('rotated');
    }

    // Toggle all modules at once
    function toggleAllModules() {
        const contents = document.querySelectorAll('.module-content');
        const chevrons = document.querySelectorAll('.chevron-icon');
        const btn = document.getElementById('toggleAllBtn');
        const allExpanded = Array.from(contents).some(c => c.classList.contains('expanded'));
        
        contents.forEach(content => {
            if (content.id.startsWith('module')) {
                if (allExpanded) {
                    content.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                }
            }
        });
        
        chevrons.forEach(chevron => {
            if (chevron.id.startsWith('chevron')) {
                if (allExpanded) {
                    chevron.classList.remove('rotated');
                } else {
                    chevron.classList.add('rotated');
                }
            }
        });
        
        // Update button text
        if (allExpanded) {
            btn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Buka Semua';
        } else {
            btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Tutup Semua';
        }
    }

    // Desktop: Scroll to top function
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // Auto-expand first incomplete module on load
    document.addEventListener('DOMContentLoaded', function() {
        // Find first incomplete module
        const modules = document.querySelectorAll('.module-item');
        for (let i = 0; i < modules.length; i++) {
            const moduleId = 'module' + (i + 1);
            const moduleContent = document.getElementById(moduleId);
            if (moduleContent) {
                const hasIncompleteContent = moduleContent.querySelector('.bg-gray-200');
                if (hasIncompleteContent) {
                    toggleModule(moduleId);
                    // Scroll into view
                    setTimeout(() => {
                        moduleContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                    break;
                }
            }
        }

        // Add stagger animation to cards
        const cards = document.querySelectorAll('.animate-slide-in');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '1';
            }, index * 50);
        });

        // Haptic feedback for iOS (if available)
        if ('vibrate' in navigator) {
            document.querySelectorAll('.card-press').forEach(el => {
                el.addEventListener('touchstart', () => {
                    navigator.vibrate(10);
                });
            });
        }

        // Prevent bounce scrolling on iOS
        let startY;
        const content = document.querySelector('.bg-gray-50');
        if (content) {
            content.addEventListener('touchstart', e => {
                startY = e.touches[0].pageY;
            });
            
            content.addEventListener('touchmove', e => {
                const y = e.touches[0].pageY;
                const scrollTop = content.scrollTop;
                const scrollHeight = content.scrollHeight;
                const height = content.clientHeight;
                
                // Prevent overscroll
                if ((scrollTop <= 0 && y > startY) || 
                    (scrollTop + height >= scrollHeight && y < startY)) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Lazy load images if any
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('skeleton');
                        observer.unobserve(img);
                    }
                });
            });

            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
        }

        // Service Worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            // Uncomment to enable service worker
            // navigator.serviceWorker.register('/sw.js');
        }

        // Add pull-to-refresh indicator
        let pStart = { x: 0, y: 0 };
        let pCurrent = { x: 0, y: 0 };
        
        document.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            pStart.x = touch.screenX;
            pStart.y = touch.screenY;
        });

        document.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            pCurrent.x = touch.screenX;
            pCurrent.y = touch.screenY;
        });

        document.addEventListener('touchend', () => {
            const changeY = pStart.y - pCurrent.y;
            const changeX = pStart.x - pCurrent.x;
            
            // Swipe from left edge to go back
            if (pStart.x < 50 && changeX < -100 && Math.abs(changeY) < 50) {
                window.history.back();
            }
        });

        // ==================== DESKTOP FEATURES ====================
        
        // Show/hide floating action button on scroll
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        if (scrollTopBtn) {
            window.addEventListener('scroll', debounce(() => {
                if (window.scrollY > 300) {
                    scrollTopBtn.style.opacity = '1';
                    scrollTopBtn.style.pointerEvents = 'auto';
                } else {
                    scrollTopBtn.style.opacity = '0';
                    scrollTopBtn.style.pointerEvents = 'none';
                }
            }, 100));
        }

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Keyboard shortcuts for desktop
        if (window.innerWidth >= 1024) {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K: Focus search (if implemented)
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    // Add search focus logic here
                }
                
                // Escape: Close all expanded modules
                if (e.key === 'Escape') {
                    const expandedModules = document.querySelectorAll('.module-content.expanded');
                    expandedModules.forEach(module => {
                        if (module.id.startsWith('module')) {
                            toggleModule(module.id);
                        }
                    });
                }
                
                // Up arrow: Scroll to top
                if (e.ctrlKey && e.key === 'ArrowUp') {
                    e.preventDefault();
                    scrollToTop();
                }
            });
        }

        // Add hover sound effect (optional, subtle)
        const hoverElements = document.querySelectorAll('.desktop-hover-lift, .stat-card');
        hoverElements.forEach(el => {
            el.addEventListener('mouseenter', () => {
                // You can add subtle audio feedback here if desired
                // const audio = new Audio('/static/sounds/hover.mp3');
                // audio.volume = 0.1;
                // audio.play();
            });
        });

        // Progress ring animation on viewport entry
        const progressRings = document.querySelectorAll('.progress-ring-circle');
        if ('IntersectionObserver' in window) {
            const ringObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'fillProgress 1s ease-out forwards';
                    }
                });
            }, { threshold: 0.5 });

            progressRings.forEach(ring => ringObserver.observe(ring));
        }

        // Auto-save scroll position for better UX
        const scrollKey = 'course_detail_scroll_' + window.location.pathname;
        const savedScroll = sessionStorage.getItem(scrollKey);
        if (savedScroll) {
            window.scrollTo(0, parseInt(savedScroll));
        }

        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem(scrollKey, window.scrollY.toString());
        });

        // Desktop: Show tooltips programmatically
        const tooltipElements = document.querySelectorAll('[data-tooltip]');
        tooltipElements.forEach(el => {
            el.addEventListener('mouseenter', function() {
                // Tooltip is handled via CSS ::after pseudo-element
            });
        });

        // Prefetch next module content for faster loading
        if (window.innerWidth >= 1024 && 'requestIdleCallback' in window) {
            requestIdleCallback(() => {
                const moduleLinks = document.querySelectorAll('a[href*="student_content_view"]');
                moduleLinks.forEach(link => {
                    const prefetchLink = document.createElement('link');
                    prefetchLink.rel = 'prefetch';
                    prefetchLink.href = link.href;
                    document.head.appendChild(prefetchLink);
                });
            });
        }
    });

    // Performance optimization: Debounce scroll events
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Track scroll position for header shadow
    const handleScroll = debounce(() => {
        const header = document.querySelector('.sticky-mobile-header');
        if (header) {
            if (window.scrollY > 20) {
                header.classList.add('shadow-md');
            } else {
                header.classList.remove('shadow-md');
            }
        }
    }, 10);

    window.addEventListener('scroll', handleScroll, { passive: true });

    // Optimize touch interactions
    document.addEventListener('touchstart', function() {}, { passive: true });

    // Desktop: Add parallax effect to header (subtle)
    if (window.innerWidth >= 1024) {
        window.addEventListener('scroll', debounce(() => {
            const header = document.querySelector('.desktop-gradient-bg');
            if (header) {
                const scrolled = window.scrollY;
                header.style.transform = `translateY(${scrolled * 0.5}px)`;
            }
        }, 10), { passive: true });
    }

    // Print-friendly styles
    window.addEventListener('beforeprint', () => {
        // Expand all modules before printing
        document.querySelectorAll('.module-content').forEach(content => {
            if (content.id.startsWith('module')) {
                content.style.maxHeight = 'none';
            }
        });
    });

    window.addEventListener('afterprint', () => {
        // Restore collapsed state
        document.querySelectorAll('.module-content').forEach(content => {
            if (content.id.startsWith('module') && !content.classList.contains('expanded')) {
                content.style.maxHeight = '0';
            }
        });
    });
</script>
{% endblock %}
