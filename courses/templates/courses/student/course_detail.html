{% extends "base.html" %}
{% load course %}

{% block title %}{{ course.title }} - Ta3lem{% endblock %}

{% block extra_css %}
<style>
    /* Module collapse/expand animation */
    .module-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .module-content.expanded {
        max-height: 2000px;
    }

    .chevron-icon {
        transition: transform 0.3s ease;
    }

    .chevron-icon.rotated {
        transform: rotate(180deg);
    }

    /* Progress animations */
    @keyframes fillProgress {
        from { stroke-dashoffset: 251.2; }
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.5s ease;
        animation: fillProgress 1s ease-out;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Hero Section -->
    <div class="relative bg-gradient-to-br from-blue-600 via-purple-600 to-pink-500 text-white py-8 sm:py-12 lg:py-16 overflow-hidden">
        <div class="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-black/30"></div>
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="mb-4">
                <a href="{% url 'student_course_list' %}"
                   class="inline-flex items-center text-white/90 hover:text-white text-xs sm:text-sm font-semibold px-3 sm:px-4 py-2 bg-white/10 backdrop-blur-sm rounded-full hover:bg-white/20 transition-all duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span>Kembali ke Daftar Kursus</span>
                </a>
            </div>

            <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-extrabold mb-3 leading-tight">{{ course.title }}</h1>

            <div class="flex items-center gap-3 sm:gap-4 flex-wrap text-sm sm:text-base text-blue-100 mb-4">
                <span class="flex items-center gap-2">
                    <i class="fas fa-user"></i>
                    <span>{{ course.owner.username }}</span>
                </span>
                <span>•</span>
                <span class="flex items-center gap-2">
                    <i class="fas fa-tag"></i>
                    <span>{{ course.subject.title }}</span>
                </span>
                <span>•</span>
                <span class="flex items-center gap-2">
                    <i class="fas fa-layer-group"></i>
                    <span>{{ course.modules.count }} Modul</span>
                </span>
            </div>

            <!-- Progress Bar -->
            <div class="max-w-md">
                <div class="flex items-center justify-between mb-2 text-sm">
                    <span class="text-blue-100">Progress Pembelajaran</span>
                    <span class="font-bold">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                </div>
                <div class="w-full bg-white/20 rounded-full h-3 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500"
                         style="width: {{ enrollment.progress_percentage }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 lg:py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Continue Learning CTA -->
                {% if current_module and current_module_first_content %}
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all">
                    <a href="{% url 'student_content_view' course.pk current_module.pk current_module_first_content.pk %}"
                       class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-play text-white text-3xl"></i>
                        </div>
                        <div class="flex-1 text-white">
                            <p class="text-sm font-semibold text-blue-100 mb-1">Lanjutkan Belajar</p>
                            <h3 class="font-bold text-xl mb-1">{{ current_module.title }}</h3>
                            <p class="text-sm text-blue-100">{{ current_module_first_content.title }}</p>
                        </div>
                        <div class="hidden sm:flex items-center gap-2 text-white">
                            <span class="text-sm font-semibold">Mulai</span>
                            <i class="fas fa-arrow-right text-xl"></i>
                        </div>
                    </a>
                </div>
                {% endif %}

                <!-- Course Overview -->
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-info-circle text-white"></i>
                        </div>
                        <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900">Tentang Kursus</h2>
                    </div>
                    <p class="text-gray-700 leading-relaxed">{{ course.overview }}</p>
                </div>

                <!-- Modules List -->
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-list-ul text-white"></i>
                            </div>
                            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900">Daftar Modul</h2>
                        </div>
                        {% if modules_data %}
                        <button onclick="toggleAllModules()" id="toggleAllBtn"
                                class="text-sm text-blue-600 font-semibold hover:text-blue-700 transition-colors flex items-center gap-2">
                            <i class="fas fa-chevron-down"></i>
                            <span class="hidden sm:inline">Buka Semua</span>
                        </button>
                        {% endif %}
                    </div>

                    {% if modules_data %}
                        <div class="space-y-4">
                            {% for module_data in modules_data %}
                            <div class="border-2 rounded-xl overflow-hidden transition-all duration-200
                                        {% if module_data.progress.is_completed %}border-green-300 bg-green-50/50{% else %}border-gray-200 hover:border-blue-300 hover:shadow-lg{% endif %}">
                                <!-- Module Header -->
                                <div onclick="toggleModule('module{{ forloop.counter }}')"
                                     class="px-5 py-4 hover:bg-gray-50 cursor-pointer transition-colors">
                                    <div class="flex items-center gap-4">
                                        <!-- Module Number Badge -->
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 shadow-md
                                                    {% if module_data.progress.is_completed %}bg-gradient-to-br from-green-400 to-green-600{% else %}bg-gradient-to-br from-blue-500 to-purple-600{% endif %}">
                                            {% if module_data.progress.is_completed %}
                                                <i class="fas fa-check text-white text-lg"></i>
                                            {% else %}
                                                <span class="text-white font-bold text-lg">{{ forloop.counter }}</span>
                                            {% endif %}
                                        </div>

                                        <!-- Module Info -->
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-bold text-gray-900 text-lg mb-1">{{ module_data.module.title }}</h3>
                                            <div class="flex items-center gap-3 text-sm text-gray-600 flex-wrap">
                                                <span class="{% if module_data.progress.is_completed %}text-green-600{% else %}text-blue-600{% endif %} font-semibold">
                                                    {{ module_data.completed_contents }}/{{ module_data.total_contents }} Selesai
                                                </span>
                                                <span>•</span>
                                                <span class="font-medium">{{ module_data.completion_percentage|floatformat:0 }}%</span>
                                            </div>
                                        </div>

                                        <!-- Status Badge -->
                                        <div class="hidden sm:block">
                                            {% if module_data.progress.is_completed %}
                                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">
                                                <i class="fas fa-check-circle mr-1"></i>Selesai
                                            </span>
                                            {% elif module_data.completed_contents > 0 %}
                                            <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold">
                                                <i class="fas fa-play-circle mr-1"></i>Berlangsung
                                            </span>
                                            {% else %}
                                            <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold">
                                                <i class="fas fa-circle mr-1"></i>Belum Dimulai
                                            </span>
                                            {% endif %}
                                        </div>

                                        <!-- Chevron -->
                                        <i class="fas fa-chevron-down text-gray-400 chevron-icon transition-transform" id="chevron{{ forloop.counter }}"></i>
                                    </div>

                                    <!-- Progress Bar -->
                                    <div class="mt-4">
                                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                            <div class="{% if module_data.progress.is_completed %}bg-gradient-to-r from-green-400 to-green-600{% else %}bg-gradient-to-r from-blue-500 to-purple-600{% endif %}
                                                        h-2 rounded-full transition-all duration-500"
                                                 style="width: {{ module_data.completion_percentage }}%"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Module Contents (Collapsible) -->
                                <div class="module-content" id="module{{ forloop.counter }}">
                                    <div class="px-5 pb-5 bg-gray-50">
                                        {% if module_data.module.contents.all %}
                                            <div class="space-y-2">
                                                {% for content in module_data.module.contents.all %}
                                                    {% for cd in contents_data %}
                                                        {% if cd.content.pk == content.pk %}
                                                        <a href="{% url 'student_content_view' course.pk module_data.module.pk content.pk %}"
                                                           class="flex items-center gap-4 p-4 rounded-xl hover:bg-white transition-all border border-gray-200 hover:border-blue-300 hover:shadow-sm group">
                                                            <!-- Status Icon -->
                                                            <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0
                                                                        {% if cd.is_completed %}bg-green-500{% else %}bg-gray-200 group-hover:bg-blue-100{% endif %} transition-all">
                                                                {% if cd.is_completed %}
                                                                    <i class="fas fa-check text-white"></i>
                                                                {% else %}
                                                                    <i class="fas fa-circle text-gray-400 group-hover:text-blue-500 transition-colors"></i>
                                                                {% endif %}
                                                            </div>

                                                            <!-- Content Info -->
                                                            <div class="flex-1 min-w-0">
                                                                <p class="text-base font-medium text-gray-900 group-hover:text-blue-600 transition-colors">{{ content.title }}</p>
                                                                <p class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                                                    <i class="fas fa-file-alt text-xs"></i>
                                                                    {{ content.items.count }} item{% if content.items.count > 1 %}s{% endif %}
                                                                </p>
                                                            </div>

                                                            <i class="fas fa-chevron-right text-gray-400 text-sm group-hover:text-blue-600 transition-colors"></i>
                                                        </a>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endfor %}
                                            </div>

                                            <!-- Action Button -->
                                            {% if module_data.first_content %}
                                            <a href="{% url 'student_content_view' course.pk module_data.module.pk module_data.first_content.pk %}"
                                               class="block w-full mt-4 text-center
                                                      {% if module_data.progress.is_completed %}
                                                          bg-green-500 hover:bg-green-600
                                                      {% else %}
                                                          bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700
                                                      {% endif %}
                                                      text-white font-semibold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition-all">
                                                {% if module_data.progress.is_completed %}
                                                    <i class="fas fa-redo mr-2"></i>Tinjau Ulang Modul
                                                {% elif module_data.completed_contents > 0 %}
                                                    <i class="fas fa-play-circle mr-2"></i>Lanjutkan Belajar
                                                {% else %}
                                                    <i class="fas fa-rocket mr-2"></i>Mulai Modul Ini
                                                {% endif %}
                                            </a>
                                            {% endif %}
                                        {% else %}
                                            <div class="text-center py-8">
                                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i class="fas fa-inbox text-2xl text-gray-400"></i>
                                                </div>
                                                <p class="text-sm text-gray-500">Belum ada konten di modul ini</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-inbox text-3xl text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Belum Ada Modul</h3>
                            <p class="text-gray-600">Instruktur belum menambahkan modul untuk kursus ini</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="sticky top-24 space-y-6">
                    <!-- Progress Card -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                            Progress Pembelajaran
                        </h3>

                        <!-- Large Progress Circle -->
                        <div class="flex justify-center mb-6">
                            <div class="relative w-32 h-32">
                                <svg class="transform -rotate-90 w-32 h-32">
                                    <circle cx="64" cy="64" r="58" stroke="#e5e7eb" stroke-width="8" fill="none" />
                                    <circle cx="64" cy="64" r="58" stroke="url(#gradient)" stroke-width="8" fill="none"
                                            stroke-dasharray="364"
                                            stroke-dashoffset="{{ 364|mul:-1|mul:enrollment.progress_percentage|div:100|add:364 }}"
                                            class="progress-ring-circle" stroke-linecap="round" />
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-3xl font-bold text-gray-900">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                                    <span class="text-xs text-gray-500">Selesai</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-xl">
                                <span class="text-sm text-gray-600">Total Modul</span>
                                <span class="text-lg font-bold text-blue-600">{{ course.modules.count }}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-xl">
                                <span class="text-sm text-gray-600">Total Konten</span>
                                <span class="text-lg font-bold text-green-600">{{ contents_data|length }}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-xl">
                                <span class="text-sm text-gray-600">Bergabung</span>
                                <span class="text-sm font-bold text-purple-600">{{ enrollment.enrolled_at|date:"d M Y" }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Instructor Card -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chalkboard-teacher text-blue-500 mr-2"></i>
                            Instruktur
                        </h3>
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white text-lg"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">{{ course.owner.username }}</p>
                                <p class="text-xs text-gray-500">Pengajar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
// Wrap in IIFE to avoid variable conflicts with HTMX
(function() {
    'use strict';

    // Toggle individual module
    window.toggleModule = function(moduleId) {
        var moduleContent = document.getElementById(moduleId);
        var chevronId = moduleId.replace('module', 'chevron');
        var chevron = document.getElementById(chevronId);

        if (moduleContent) {
            moduleContent.classList.toggle('expanded');
        }
        if (chevron) {
            chevron.classList.toggle('rotated');
        }
    };

    // Toggle all modules
    window.toggleAllModules = function() {
        var allModules = document.querySelectorAll('.module-content');
        var allChevrons = document.querySelectorAll('.chevron-icon');
        var toggleBtn = document.getElementById('toggleAllBtn');

        if (!allModules || allModules.length === 0) return;

        var anyExpanded = Array.from(allModules).some(function(module) {
            return module.classList.contains('expanded');
        });

        allModules.forEach(function(module) {
            if (anyExpanded) {
                module.classList.remove('expanded');
            } else {
                module.classList.add('expanded');
            }
        });

        allChevrons.forEach(function(chevron) {
            if (anyExpanded) {
                chevron.classList.remove('rotated');
            } else {
                chevron.classList.add('rotated');
            }
        });

        if (toggleBtn) {
            var btnText = toggleBtn.querySelector('span');
            var btnIcon = toggleBtn.querySelector('i');
            if (anyExpanded) {
                if (btnText) btnText.textContent = 'Buka Semua';
                if (btnIcon) btnIcon.className = 'fas fa-chevron-down';
            } else {
                if (btnText) btnText.textContent = 'Tutup Semua';
                if (btnIcon) btnIcon.className = 'fas fa-chevron-up';
            }
        }
    };

    // Initialize
    function initCourseDetail() {
        // Any additional initialization can go here
        console.log('Course detail initialized');
    }

    // Run on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCourseDetail);
    } else {
        initCourseDetail();
    }

    // Re-run on htmx:afterSwap for HTMX compatibility
    document.body.addEventListener('htmx:afterSwap', initCourseDetail);
})();
</script>
{% endblock %}

