{% load static %}
{% load vite %}
{% load django_htmx %}
<!DOCTYPE html>
<html lang="id" class="h-full bg-primary-50">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- Performance optimization hints -->
        <meta name="theme-color" content="#fafaf9">
        <!-- Preconnect to external domains for faster resource loading -->
        <link rel="dns-prefetch" href="https://kit.fontawesome.com">
        <title>
            {% block title %}Ta3lem - Learning Management System{% endblock %}
        </title>
        <!-- Critical inline CSS for immediate rendering -->
        <style>
            /* Critical CSS for First Contentful Paint */
            html { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; scroll-behavior: smooth; }
            body { margin: 0; min-height: 100vh; background-color: #fafaf9; color: #1c1917; -webkit-font-smoothing: antialiased; }
            header { background-color: #ffffff; border-bottom: 1px solid #e7e5e4; position: sticky; top: 0; z-index: 50; }
            nav { max-width: 80rem; margin: 0 auto; padding: 1rem; }
            [x-cloak] { display: none !important; }
            .htmx-indicator { display: none; }
            .htmx-request .htmx-indicator { display: flex; }
        </style>
        <!-- Vite assets -->
        {% enable_vite %}
        <!-- Deferred scripts for non-critical functionality -->
        {% htmx_script %}
        <script src="https://kit.fontawesome.com/7d2035fc97.js"
                crossorigin="anonymous"
                async></script>
    </head>
    <body class="min-h-full antialiased text-primary-900 bg-primary-50"
          hx-ext="preload"
          x-data="{ mobileMenuOpen: false }">
        {% block navbar %}
            <!-- Top Navigation Bar -->
            <header class="bg-white border-b border-primary-200 sticky top-0 z-50">
                <nav class="mx-auto flex max-w-7xl items-center justify-between p-4 lg:px-8"
                     aria-label="Global">
                    <!-- Logo -->
                    <div class="flex lg:flex-1">
                        <a href="{% url 'landing' %}"
                           class="-m-1.5 p-1.5 flex items-center gap-2.5 font-semibold text-xl text-primary-900 transition-colors hover:text-primary-700">
                            <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-primary-900 to-primary-800 text-white shadow-md">
                                <i class="fas fa-graduation-cap text-sm"></i>
                            </div>
                            Ta3lem
                        </a>
                    </div>
                    <!-- Mobile Menu Button -->
                    <div class="flex lg:hidden">
                        <button type="button"
                                class="-m-2.5 inline-flex items-center justify-center rounded-lg p-2.5 text-primary-700 hover:bg-primary-100 transition-colors"
                                @click="mobileMenuOpen = true">
                            <span class="sr-only">Open main menu</span>
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex lg:gap-x-8">
                        <a href="{% url 'course_list' %}"
                           class="text-sm font-medium leading-6 {% if request.resolver_match.url_name == 'course_list' %}text-primary-900{% else %}text-primary-600 hover:text-primary-900{% endif %} transition-colors">
                            Katalog
                        </a>
                        {% if user.is_authenticated and user.role == 'student' %}
                            <a href="{% url 'student_course_list' %}"
                               class="text-sm font-medium leading-6 {% if request.resolver_match.url_name == 'student_course_list' %}text-primary-900{% else %}text-primary-600 hover:text-primary-900{% endif %} transition-colors">
                                Pembelajaran Saya
                            </a>
                        {% endif %}
                        {% if user.is_authenticated and user.role == 'instructor' %}
                            <a href="{% url 'manage_course_list' %}"
                               class="text-sm font-medium leading-6 {% if 'manage' in request.path %}text-primary-900{% else %}text-primary-600 hover:text-primary-900{% endif %} transition-colors">
                                Instruktur
                            </a>
                        {% endif %}
                    </div>
                    <!-- Right Actions (Search & Profile) -->
                    <div class="hidden lg:flex lg:flex-1 lg:justify-end lg:items-center lg:gap-x-6">
                        <!-- Search -->
                        <form class="relative group" action="#" method="GET">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-search text-primary-400 group-focus-within:text-primary-600 transition-colors"></i>
                            </div>
                            <input type="search"
                                   name="q"
                                   class="block w-full rounded-lg border-0 py-2 pl-10 pr-4 text-primary-900 ring-1 ring-inset ring-primary-200 placeholder:text-primary-400 focus:ring-2 focus:ring-inset focus:ring-primary-500 sm:text-sm bg-primary-50 hover:bg-white transition-colors"
                                   placeholder="Cari kursus...">
                        </form>
                        {% if user.is_authenticated %}
                            <!-- Profile Dropdown -->
                            <div class="relative ml-3" x-data="{ open: false }">
                                <button type="button"
                                        class="flex items-center gap-x-2 rounded-full bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                                        @click="open = !open">
                                    <span class="sr-only">Open user menu</span>
                                    <div class="h-9 w-9 rounded-full bg-gradient-to-br from-primary-100 to-primary-200 flex items-center justify-center text-primary-700 font-semibold text-sm border border-primary-200 shadow-sm">
                                        {{ user.username.0|upper }}
                                    </div>
                                </button>
                                <div x-show="open"
                                     @click.away="open = false"
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="transform opacity-0 scale-95"
                                     x-transition:enter-end="transform opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="transform opacity-100 scale-100"
                                     x-transition:leave-end="transform opacity-0 scale-95"
                                     class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-xl bg-white py-2 shadow-lg ring-1 ring-primary-900/5 focus:outline-none"
                                     x-cloak>
                                    <div class="px-4 py-3 border-b border-primary-100">
                                        <p class="text-sm font-semibold text-primary-900 truncate">{{ user.username }}</p>
                                        <p class="text-xs text-primary-500 truncate mt-0.5">{{ user.email }}</p>
                                        {% if user.is_authenticated and user.role == 'student' %}
                                            {% if user_has_subscription %}
                                                <div class="mt-2 inline-flex items-center gap-1.5 px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-semibold rounded-full">
                                                    <i class="fas fa-crown text-[10px]"></i>
                                                    <span>Premium</span>
                                                </div>
                                            {% else %}
                                                <div class="mt-2 inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100 text-primary-600 text-xs font-semibold rounded-full">
                                                    <span>Free</span>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <a href="#"
                                       class="block px-4 py-2.5 text-sm text-primary-700 hover:bg-primary-50 transition-colors">
                                        <i class="fas fa-user-circle mr-2 text-primary-400"></i> Profil Saya
                                    </a>
                                    {% if user.is_authenticated and user.role == 'student' %}
                                        <a href="{% url 'subscriptions:manage' %}"
                                           class="block px-4 py-2.5 text-sm text-primary-700 hover:bg-primary-50 transition-colors">
                                            <i class="fas fa-crown mr-2 text-primary-400"></i> Subscription
                                        </a>
                                    {% endif %}
                                    <form action="{% url 'logout' %}"
                                          method="post"
                                          class="block w-full border-t border-primary-100 mt-1 pt-1">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="block w-full text-left px-4 py-2.5 text-sm text-error-600 hover:bg-error-50 transition-colors">
                                            <i class="fas fa-sign-out-alt mr-2"></i> Keluar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% else %}
                            <a href="{% url 'student_login' %}"
                               class="text-sm font-medium leading-6 text-primary-700 hover:text-primary-900 transition-colors">Masuk</a>
                            <a href="{% url 'student_registration' %}"
                               class="btn btn-primary px-4 py-2 text-sm">
                                Daftar <span aria-hidden="true" class="ml-1">&rarr;</span>
                            </a>
                        {% endif %}
                    </div>
                </nav>
                <!-- Mobile Menu (Dialog) -->
                <div class="lg:hidden"
                     role="dialog"
                     aria-modal="true"
                     x-show="mobileMenuOpen"
                     x-cloak>
                    <div class="fixed inset-0 z-50 bg-primary-900/30 backdrop-blur-sm"
                         @click="mobileMenuOpen = false"
                         x-transition.opacity></div>
                    <div class="fixed inset-y-0 right-0 z-50 w-full overflow-y-auto bg-white px-6 py-6 sm:max-w-sm sm:ring-1 sm:ring-primary-900/10"
                         x-transition:enter="transform transition ease-in-out duration-300 sm:duration-400"
                         x-transition:enter-start="translate-x-full"
                         x-transition:enter-end="translate-x-0"
                         x-transition:leave="transform transition ease-in-out duration-300 sm:duration-400"
                         x-transition:leave-start="translate-x-0"
                         x-transition:leave-end="translate-x-full">
                        <div class="flex items-center justify-between">
                            <a href="{% url 'landing' %}"
                               class="-m-1.5 p-1.5 flex items-center gap-2 font-semibold text-xl text-primary-900">
                                <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-primary-900 to-primary-800 text-white">
                                    <i class="fas fa-graduation-cap text-xs"></i>
                                </div>
                                Ta3lem
                            </a>
                            <button type="button"
                                    class="-m-2.5 rounded-lg p-2.5 text-primary-700 hover:bg-primary-100 transition-colors"
                                    @click="mobileMenuOpen = false">
                                <span class="sr-only">Close menu</span>
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="mt-6 flow-root">
                            <div class="-my-6 divide-y divide-primary-200">
                                <div class="space-y-1 py-6">
                                    {% if user.is_authenticated %}
                                        <div class="px-3 py-3 bg-primary-50 rounded-xl mb-4">
                                            <div class="flex items-center gap-3">
                                                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-primary-100 to-primary-200 flex items-center justify-center text-primary-700 font-semibold border border-primary-200">
                                                    {{ user.username.0|upper }}
                                                </div>
                                                <div>
                                                    <p class="font-semibold text-primary-900">{{ user.username }}</p>
                                                    <p class="text-xs text-primary-500">{{ user.email }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <a href="{% url 'course_list' %}"
                                       class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-medium leading-7 text-primary-900 hover:bg-primary-50 transition-colors">
                                        <i class="fas fa-book-open w-6 text-primary-400"></i> Katalog
                                    </a>
                                    {% if user.is_authenticated and user.role == 'student' %}
                                        <a href="{% url 'student_course_list' %}"
                                           class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-medium leading-7 text-primary-900 hover:bg-primary-50 transition-colors">
                                            <i class="fas fa-graduation-cap w-6 text-primary-400"></i> Pembelajaran Saya
                                        </a>
                                        <a href="{% url 'subscriptions:manage' %}"
                                           class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-medium leading-7 text-primary-900 hover:bg-primary-50 transition-colors">
                                            <i class="fas fa-crown w-6 text-primary-400"></i> Subscription
                                        </a>
                                    {% endif %}
                                    {% if user.is_authenticated and user.role == 'instructor' %}
                                        <a href="{% url 'manage_course_list' %}"
                                           class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-medium leading-7 text-primary-900 hover:bg-primary-50 transition-colors">
                                            <i class="fas fa-chalkboard-teacher w-6 text-primary-400"></i> Instruktur
                                        </a>
                                    {% endif %}
                                </div>
                                <div class="py-6">
                                    {% if user.is_authenticated %}
                                        <form action="{% url 'logout' %}" method="post">
                                            {% csrf_token %}
                                            <button type="submit"
                                                    class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-medium leading-7 text-error-600 hover:bg-error-50 w-full text-left transition-colors">
                                                <i class="fas fa-sign-out-alt w-6"></i> Keluar
                                            </button>
                                        </form>
                                    {% else %}
                                        <a href="{% url 'student_login' %}"
                                           class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-medium leading-7 text-primary-900 hover:bg-primary-50 transition-colors">Masuk</a>
                                        <a href="{% url 'student_registration' %}"
                                           class="mt-4 btn btn-primary w-full py-3 text-center text-base">Daftar Sekarang</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
        {% endblock %}
        <!-- Main Content -->
        <main class="min-h-[calc(100vh-4.5rem)]" id="main-content">
            <!-- HTMX Indicator -->
            <div class="htmx-indicator fixed top-4 right-1/2 translate-x-1/2 z-50">
                <div class="bg-primary-900/90 backdrop-blur text-white px-4 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-medium">
                    <svg class="animate-spin h-4 w-4 text-white"
                         fill="none"
                         viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span>Memuat...</span>
                </div>
            </div>
            {% block content %}{% endblock %}
        </main>
        {% block footer %}
            <!-- Footer -->
            <footer class="bg-white border-t border-primary-200 py-10 mt-auto">
                <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 text-center text-primary-500 text-sm">
                    <p>&copy; 2025 Ta3lem. All rights reserved.</p>
                </div>
            </footer>
        {% endblock %}
        <script>
        // Get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Configure HTMX to send CSRF token with every request
        document.addEventListener('DOMContentLoaded', function () {
            // HTMX configuration
            htmx.config.defaultSwapStyle = 'innerHTML';
            htmx.config.defaultSwapDelay = 0;
            htmx.config.defaultSettleDelay = 100;
            
            // Add CSRF token to all HTMX requests
            document.body.addEventListener('htmx:configRequest', function(event) {
                const csrfToken = getCookie('csrftoken');
                if (csrfToken) {
                    event.detail.headers['X-CSRFToken'] = csrfToken;
                }
            });
            
            // Scroll to top after swap
            document.body.addEventListener('htmx:afterSwap', function (event) {
                if (event.detail.target.id === 'main-content' || event.detail.target.tagName === 'MAIN') {
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            });
        });
        </script>
    </body>
</html>
