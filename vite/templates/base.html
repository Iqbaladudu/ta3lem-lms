{% load static %}
{% load vite %}
{% load django_htmx %}

<!DOCTYPE html>
<html lang="id" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Ta3lem - Learning Management System{% endblock %}</title>
    {% enable_vite %}
    {% htmx_script %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none !important; }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="min-h-full antialiased text-slate-900 bg-slate-50" hx-ext="preload" x-data="{ mobileMenuOpen: false }">

    {% block navbar %}
    <!-- Top Navigation Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <nav class="mx-auto flex max-w-7xl items-center justify-between p-4 lg:px-8" aria-label="Global">
            
            <!-- Logo -->
            <div class="flex lg:flex-1">
                <a href="{% url 'course_list' %}" class="-m-1.5 p-1.5 flex items-center gap-2 font-bold text-xl text-slate-900">
                    <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-indigo-600 text-white shadow-sm hover:bg-indigo-500 transition-colors">
                        <i class="fas fa-graduation-cap text-base"></i>
                    </div>
                    Ta3lem
                </a>
            </div>

            <!-- Mobile Menu Button -->
            <div class="flex lg:hidden">
                <button type="button" class="-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-slate-700 hover:bg-slate-50" @click="mobileMenuOpen = true">
                    <span class="sr-only">Open main menu</span>
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Desktop Navigation -->
            <div class="hidden lg:flex lg:gap-x-8">
                <a href="{% url 'course_list' %}" class="text-sm font-semibold leading-6 {% if request.resolver_match.url_name == 'course_list' %}text-indigo-600{% else %}text-slate-900 hover:text-indigo-600{% endif %} transition-colors">
                    Katalog
                </a>
                
                {% if user.is_authenticated and user.role == 'student' %}
                <a href="{% url 'student_course_list' %}" class="text-sm font-semibold leading-6 {% if request.resolver_match.url_name == 'student_course_list' %}text-indigo-600{% else %}text-slate-900 hover:text-indigo-600{% endif %} transition-colors">
                    Pembelajaran Saya
                </a>
                {% endif %}

                {% if user.is_authenticated and user.role == 'instructor' %}
                <a href="{% url 'manage_course_list' %}" class="text-sm font-semibold leading-6 {% if 'manage' in request.path %}text-indigo-600{% else %}text-slate-900 hover:text-indigo-600{% endif %} transition-colors">
                    Instruktur
                </a>
                {% endif %}
            </div>

            <!-- Right Actions (Search & Profile) -->
            <div class="hidden lg:flex lg:flex-1 lg:justify-end lg:items-center lg:gap-x-6">
                 <!-- Search -->
                <form class="relative group" action="#" method="GET">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <input type="search" name="q" class="block w-full rounded-full border-0 py-1.5 pl-10 pr-3 text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 bg-slate-50 hover:bg-white transition-colors" placeholder="Cari kursus...">
                </form>

                {% if user.is_authenticated %}
                    <!-- Profile Dropdown -->
                    <div class="relative ml-3" x-data="{ open: false }">
                        <button type="button" class="flex items-center gap-x-2 rounded-full bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" @click="open = !open">
                            <span class="sr-only">Open user menu</span>
                            <div class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold border border-slate-200">
                                {{ user.username.0|upper }}
                            </div>
                        </button>

                        <div x-show="open" @click.away="open = false" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" x-cloak>
                            <div class="px-4 py-2 border-b border-gray-100">
                                <p class="text-sm font-semibold text-gray-900 truncate">{{ user.username }}</p>
                                <p class="text-xs text-gray-500 truncate">{{ user.email }}</p>
                            </div>
                            <!-- Fixed: Use # until profile view exists -->
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profil Saya</a>
                            
                             <form action="{% url 'logout' %}" method="post" class="block w-full">
                                {% csrf_token %}
                                <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Keluar</button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <a href="{% url 'student_login' %}" class="text-sm font-semibold leading-6 text-slate-900 hover:text-indigo-600">Masuk</a>
                    <a href="{% url 'student_registration' %}" class="rounded-lg bg-indigo-600 px-3.5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Daftar <span aria-hidden="true">&rarr;</span></a>
                {% endif %}
            </div>
        </nav>

        <!-- Mobile Menu (Dialog) -->
        <div class="lg:hidden" role="dialog" aria-modal="true" x-show="mobileMenuOpen" x-cloak>
            <div class="fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm" @click="mobileMenuOpen = false" x-transition.opacity></div>
            <div class="fixed inset-y-0 right-0 z-50 w-full overflow-y-auto bg-white px-6 py-6 sm:max-w-sm sm:ring-1 sm:ring-slate-900/10"
                 x-transition:enter="transform transition ease-in-out duration-300 sm:duration-500"
                 x-transition:enter-start="translate-x-full"
                 x-transition:enter-end="translate-x-0"
                 x-transition:leave="transform transition ease-in-out duration-300 sm:duration-500"
                 x-transition:leave-start="translate-x-0"
                 x-transition:leave-end="translate-x-full">
                 
                <div class="flex items-center justify-between">
                    <a href="#" class="-m-1.5 p-1.5 flex items-center gap-2 font-bold text-xl text-slate-900">
                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-600 text-white">
                            <i class="fas fa-graduation-cap text-sm"></i>
                        </div>
                        Ta3lem
                    </a>
                    <button type="button" class="-m-2.5 rounded-md p-2.5 text-slate-700" @click="mobileMenuOpen = false">
                        <span class="sr-only">Close menu</span>
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mt-6 flow-root">
                    <div class="-my-6 divide-y divide-gray-500/10">
                        <div class="space-y-2 py-6">
                            {% if user.is_authenticated %}
                                <div class="px-3 py-2 bg-slate-50 rounded-lg mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="h-10 w-10 rounded-full bg-white flex items-center justify-center text-slate-600 font-bold border border-slate-200">
                                            {{ user.username.0|upper }}
                                        </div>
                                        <div>
                                            <p class="font-semibold text-slate-900">{{ user.username }}</p>
                                            <p class="text-xs text-slate-500">{{ user.email }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <a href="{% url 'course_list' %}" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-slate-900 hover:bg-slate-50">
                                <i class="fas fa-book-open w-6 text-slate-400"></i> Katalog
                            </a>
                            
                            {% if user.is_authenticated and user.role == 'student' %}
                            <a href="{% url 'student_course_list' %}" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-slate-900 hover:bg-slate-50">
                                <i class="fas fa-graduation-cap w-6 text-slate-400"></i> Pembelajaran Saya
                            </a>
                            {% endif %}

                            {% if user.is_authenticated and user.role == 'instructor' %}
                            <a href="{% url 'manage_course_list' %}" class="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-slate-900 hover:bg-slate-50">
                                <i class="fas fa-chalkboard-teacher w-6 text-slate-400"></i> Instruktur
                            </a>
                            {% endif %}
                        </div>
                        
                        <div class="py-6">
                             {% if user.is_authenticated %}
                                <form action="{% url 'logout' %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-semibold leading-7 text-red-600 hover:bg-red-50 w-full text-left">
                                        <i class="fas fa-sign-out-alt w-6"></i> Keluar
                                    </button>
                                </form>
                            {% else %}
                                <a href="{% url 'student_login' %}" class="-mx-3 block rounded-lg px-3 py-2.5 text-base font-semibold leading-7 text-slate-900 hover:bg-slate-50">Masuk</a>
                                <a href="{% url 'student_registration' %}" class="mt-4 block w-full rounded-lg bg-indigo-600 px-3 py-2.5 text-center text-base font-semibold text-white shadow-sm hover:bg-indigo-500">Daftar Sekarang</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    {% endblock %}

    <!-- Main Content -->
    <main class="min-h-[calc(100vh-4.5rem)]" id="main-content">
        <!-- HTMX Indicator -->
        <div class="htmx-indicator fixed top-4 right-1/2 translate-x-1/2 z-50">
            <div class="bg-indigo-600/90 backdrop-blur text-white px-4 py-2 rounded-full shadow-lg flex items-center space-x-2 text-sm font-medium">
                <svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>Memuat...</span>
            </div>
        </div>

        {% block content %}{% endblock %}
    </main>

    {% block footer %}
    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-8 mt-auto">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 text-center text-slate-500 text-sm">
            <p>&copy; 2025 Ta3lem. All rights reserved.</p>
        </div>
    </footer>
    {% endblock %}

    <!-- Scripts -->
    {% block extra_js %}{% endblock %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            htmx.config.defaultSwapStyle = 'innerHTML';
            htmx.config.defaultSwapDelay = 0;
            htmx.config.defaultSettleDelay = 100;
            
            document.body.addEventListener('htmx:afterSwap', function (event) {
                if (event.detail.target.id === 'main-content' || event.detail.target.tagName === 'MAIN') {
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            });
        });
    </script>
</body>
</html>
